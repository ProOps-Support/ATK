<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sistem Inventaris ATK</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Babel untuk JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none;  scrollbar-width: none; }
        
        @media print {
            body * { visibility: hidden; }
            #print-area, #print-area * { visibility: visible; }
            #print-area { position: absolute; left: 0; top: 0; width: 100%; margin: 0; padding: 0; }
            .print\:hidden { display: none !important; }
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">
    <div id="root"></div>

    <!-- Script Utama dengan type="text/babel" -->
    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef, useMemo } from 'https://esm.sh/react@18.2.0';
        import ReactDOM from 'https://esm.sh/react-dom@18.2.0/client';
        import { 
            LayoutDashboard, Package, ShoppingCart, History, Menu, Plus, Search, Trash2, Edit, Check, X, 
            AlertTriangle, ArrowUpRight, ArrowDownLeft, Banknote, FileText, Printer, Camera, Upload, Save, 
            Eraser, Users, Wifi, WifiOff, Calendar, ClipboardList, LogOut, ScanBarcode, QrCode, Tag, 
            BarChart3, TrendingUp, Filter, Building2, Download, Info, Database, Bell, Shield, Server
        } from 'https://esm.sh/lucide-react@0.303.0';

        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { 
            getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy, serverTimestamp, getDoc, setDoc
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { 
            getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // --- CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyAn5SPEUZO8sIoYSL0YvRON80C-OzS7odA",
            authDomain: "stock-atk-2a300.firebaseapp.com",
            projectId: "stock-atk-2a300",
            storageBucket: "stock-atk-2a300.firebasestorage.app",
            messagingSenderId: "800795365519",
            appId: "1:800795365519:web:766e630bd962235ba8e0fa"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const appId = 'stock-atk-prod'; 

        // --- HELPERS ---
        const formatRupiah = (number) => {
            const val = Number(number) || 0;
            return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(val);
        };

        const exportTableToExcel = (tableId, filename = 'download.xls') => {
            const table = document.getElementById(tableId);
            if (!table) return;
            const html = table.outerHTML;
            const blob = new Blob([`
                <html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:x='urn:schemas-microsoft-com:office:excel' xmlns='http://www.w3.org/TR/REC-html40'>
                <head><meta charset='utf-8'></head><body>${html}</body></html>
            `], { type: 'application/vnd.ms-excel' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        };

        // --- COMPONENTS ---

        const NavItem = ({ icon, label, isActive, onClick, isOpen, count }) => (
            <button onClick={onClick} className={`w-full flex items-center px-4 py-3 transition-colors ${isActive ? 'bg-slate-800 border-r-4 border-blue-500 text-blue-400' : 'text-slate-300 hover:bg-slate-800'}`}>
                <span className="mr-3 shrink-0">{icon}</span>
                <span className={`flex-1 text-left text-sm font-medium whitespace-nowrap overflow-hidden transition-all duration-300 ${isOpen ? 'opacity-100 w-auto' : 'opacity-0 w-0'}`}>
                    {label}
                </span>
                {isOpen && count > 0 && <span className="bg-red-500 text-white text-xs px-2 py-0.5 rounded-full ml-auto">{count}</span>}
            </button>
        );

        const StatCard = ({ title, value, icon, color, isWarning }) => (
            <div className={`p-4 rounded-xl shadow-sm border border-gray-100 flex items-center justify-between ${isWarning ? 'ring-2 ring-red-100' : ''} bg-white`}>
                <div><p className="text-xs font-medium text-gray-500">{title}</p><h3 className="text-xl font-bold mt-1">{value}</h3></div>
                <div className={`p-2 rounded-lg ${color}`}>{icon}</div>
            </div>
        );

        // --- INFORMATION & SETTINGS VIEW ---
        const InformationView = ({ db, appId, itemsCount, transactionsCount, requestsCount }) => {
            const [waToken, setWaToken] = useState('');
            const [waGroupId, setWaGroupId] = useState('');
            const [waTarget, setWaTarget] = useState('');
            const [notifPrefs, setNotifPrefs] = useState({
                newRequest: true,
                stockLow: true,
                approved: false,
                rejected: false,
                itemIn: false,
                itemOut: false
            });
            const [isSaving, setIsSaving] = useState(false);

            // Mock Storage Calculation
            const totalDocs = itemsCount + transactionsCount + requestsCount;
            // Anggap 1 dokumen rata-rata 1KB + overhead, kuota free 1GB (1,000,000 KB)
            const storageUsedKB = totalDocs * 2; 
            const storagePercent = Math.min((storageUsedKB / 500000) * 100, 100).toFixed(2); // Mock 500MB Limit visually

            useEffect(() => {
                const loadSettings = async () => {
                    try {
                        // FIXED PATH: added 'general' as document ID to make even number of segments (6)
                        const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'general');
                        const docSnap = await getDoc(docRef);
                        if (docSnap.exists()) {
                            const data = docSnap.data();
                            setWaToken(data.waToken || '');
                            setWaGroupId(data.waGroupId || '');
                            setWaTarget(data.waTarget || '');
                            if (data.notifPrefs) setNotifPrefs(data.notifPrefs);
                        }
                    } catch (e) { console.error("Load settings error", e); }
                };
                loadSettings();
            }, [db, appId]);

            const handleSave = async () => {
                setIsSaving(true);
                try {
                    // FIXED PATH: added 'general' as document ID
                    await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'general'), {
                        waToken, waGroupId, waTarget, notifPrefs, updatedAt: new Date().toISOString()
                    });
                    alert('Pengaturan berhasil disimpan!');
                } catch (e) {
                    alert('Gagal menyimpan pengaturan.');
                    console.error(e);
                } finally {
                    setIsSaving(false);
                }
            };

            const togglePref = (key) => {
                setNotifPrefs(prev => ({ ...prev, [key]: !prev[key] }));
            };

            return (
                <div className="space-y-6">
                    {/* Card 1: Informasi Aplikasi & Storage */}
                    <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                        <h3 className="font-bold text-gray-800 border-b pb-3 mb-4 flex items-center gap-2">
                            <Info size={20} className="text-blue-600"/> Informasi Sistem
                        </h3>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <div>
                                <div className="space-y-3 text-sm">
                                    <div className="flex justify-between"><span className="text-gray-500">Nama Aplikasi</span> <span className="font-medium">Sistem Inventaris ATK</span></div>
                                    <div className="flex justify-between"><span className="text-gray-500">Versi</span> <span className="font-medium">v2.4.0 (Stable)</span></div>
                                    <div className="flex justify-between"><span className="text-gray-500">Tanggal Pembuatan</span> <span className="font-medium">07 Februari 2026</span></div>
                                    <div className="flex justify-between"><span className="text-gray-500">Departemen</span> <span className="font-medium">Operational Support</span></div>
                                </div>
                            </div>
                            <div>
                                <h4 className="text-sm font-bold text-gray-700 mb-2 flex items-center gap-2"><Database size={16}/> Monitor Penyimpanan (Database)</h4>
                                <div className="w-full bg-gray-200 rounded-full h-4 mb-2">
                                    <div className="bg-green-500 h-4 rounded-full transition-all duration-1000" style={{ width: `${storagePercent}%` }}></div>
                                </div>
                                <div className="flex justify-between text-xs text-gray-500">
                                    <span>Terpakai: {totalDocs} Dokumen (~{storageUsedKB} KB)</span>
                                    <span>{storagePercent}% Penuh</span>
                                </div>
                                <p className="text-xs text-gray-400 mt-1 italic">*Estimasi penggunaan berdasarkan jumlah dokumen aktif.</p>
                            </div>
                        </div>
                    </div>

                    {/* Card 2: Konfigurasi Notifikasi WhatsApp */}
                    <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                        <h3 className="font-bold text-gray-800 border-b pb-3 mb-4 flex items-center gap-2">
                            <Bell size={20} className="text-green-600"/> Konfigurasi Notifikasi (WhatsApp Gateway)
                        </h3>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <div className="space-y-4">
                                <div>
                                    <label className="block text-xs font-bold text-gray-500 mb-1">API Token WA Gateway</label>
                                    <input type="password" value={waToken} onChange={e => setWaToken(e.target.value)} className="w-full border p-2 rounded text-sm" placeholder="Masukkan Token API..." />
                                </div>
                                <div>
                                    <label className="block text-xs font-bold text-gray-500 mb-1">ID Group WhatsApp</label>
                                    <input type="text" value={waGroupId} onChange={e => setWaGroupId(e.target.value)} className="w-full border p-2 rounded text-sm" placeholder="Contoh: 12036304@g.us" />
                                </div>
                                <div>
                                    <label className="block text-xs font-bold text-gray-500 mb-1">Nomor Tujuan (Admin/PIC)</label>
                                    <input type="text" value={waTarget} onChange={e => setWaTarget(e.target.value)} className="w-full border p-2 rounded text-sm" placeholder="Contoh: 62812345678" />
                                </div>
                            </div>
                            <div>
                                <label className="block text-xs font-bold text-gray-500 mb-3">Pilih Notifikasi Aktif:</label>
                                <div className="space-y-2">
                                    <label className="flex items-center gap-2 text-sm cursor-pointer hover:bg-gray-50 p-2 rounded">
                                        <input type="checkbox" checked={notifPrefs.newRequest} onChange={() => togglePref('newRequest')} className="rounded text-blue-600"/> 
                                        <span>Permintaan Baru (User Request)</span>
                                    </label>
                                    <label className="flex items-center gap-2 text-sm cursor-pointer hover:bg-gray-50 p-2 rounded">
                                        <input type="checkbox" checked={notifPrefs.stockLow} onChange={() => togglePref('stockLow')} className="rounded text-blue-600"/> 
                                        <span>Peringatan Stok Menipis</span>
                                    </label>
                                    <label className="flex items-center gap-2 text-sm cursor-pointer hover:bg-gray-50 p-2 rounded">
                                        <input type="checkbox" checked={notifPrefs.approved} onChange={() => togglePref('approved')} className="rounded text-blue-600"/> 
                                        <span>Status Disetujui (Ke Pemohon)</span>
                                    </label>
                                    <label className="flex items-center gap-2 text-sm cursor-pointer hover:bg-gray-50 p-2 rounded">
                                        <input type="checkbox" checked={notifPrefs.rejected} onChange={() => togglePref('rejected')} className="rounded text-blue-600"/> 
                                        <span>Status Ditolak (Ke Pemohon)</span>
                                    </label>
                                    <label className="flex items-center gap-2 text-sm cursor-pointer hover:bg-gray-50 p-2 rounded">
                                        <input type="checkbox" checked={notifPrefs.itemIn} onChange={() => togglePref('itemIn')} className="rounded text-blue-600"/> 
                                        <span>Barang Masuk (Restock)</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div className="mt-6 flex justify-end">
                            <button onClick={handleSave} disabled={isSaving} className="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-bold flex items-center gap-2 shadow-sm disabled:opacity-50">
                                <Save size={18}/> {isSaving ? 'Menyimpan...' : 'Simpan Konfigurasi'}
                            </button>
                        </div>
                    </div>

                    {/* Card 3: Kebijakan HAKI */}
                    <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                        <h3 className="font-bold text-gray-800 border-b pb-3 mb-4 flex items-center gap-2">
                            <Shield size={20} className="text-purple-600"/> Kebijakan Hak Kekayaan Intelektual (HAKI)
                        </h3>
                        <div className="text-sm text-gray-600 space-y-3 leading-relaxed">
                            <p><strong>1. Hak Cipta Perangkat Lunak</strong><br/>
                            Aplikasi "Sistem Inventaris ATK" ini adalah properti eksklusif dari Direktorat Operation - Dept Operational Support. Seluruh kode sumber, desain antarmuka, dan logika bisnis dilindungi oleh undang-undang hak cipta.</p>
                            
                            <p><strong>2. Penggunaan Data</strong><br/>
                            Data yang tersimpan dalam sistem ini adalah rahasia perusahaan. Dilarang menyalin, menyebarluaskan, atau menggunakan data inventaris untuk kepentingan pribadi atau pihak ketiga tanpa izin tertulis dari manajemen.</p>

                            <p><strong>3. Modifikasi & Distribusi</strong><br/>
                            Dilarang melakukan rekayasa balik (reverse engineering), modifikasi tanpa izin, atau mendistribusikan ulang aplikasi ini di luar lingkungan internal perusahaan.</p>

                            <div className="bg-yellow-50 border-l-4 border-yellow-400 p-3 mt-4 text-xs">
                                <p className="font-bold text-yellow-800">Pernyataan Legal</p>
                                <p>Dengan menggunakan aplikasi ini, Anda menyetujui untuk mematuhi semua kebijakan keamanan informasi dan hak kekayaan intelektual yang berlaku di perusahaan.</p>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- ADMIN INVENTORY ---
        const Inventory = ({ items, onAdd, onUpdate, onDelete }) => {
            const [isModalOpen, setModalOpen] = useState(false);
            const [editingItem, setEditingItem] = useState(null);
            const [formData, setFormData] = useState({ code: '', name: '', stock: 0, unit: 'Pcs', price: 0 });

            const handleOpenModal = (item = null) => {
                if (item) {
                    setEditingItem(item);
                    setFormData({ code: item.code || '', name: item.name, stock: item.stock, unit: item.unit, price: item.price });
                } else {
                    setEditingItem(null);
                    setFormData({ code: `BRG-${Date.now().toString().slice(-6)}`, name: '', stock: 0, unit: 'Pcs', price: 0 });
                }
                setModalOpen(true);
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                const payload = { name: formData.name, code: formData.code, stock: parseInt(formData.stock), unit: formData.unit, price: parseInt(formData.price), category: 'Umum', minStock: 5 };
                if (editingItem) onUpdate({ ...editingItem, ...payload }); else onAdd(payload);
                setModalOpen(false);
            };

            return (
                <div className="bg-white rounded-xl shadow-sm border p-4">
                    <div className="flex justify-between mb-4">
                        <h3 className="font-bold text-gray-700">Master Data Barang</h3>
                        <div className="flex gap-2">
                            <button onClick={() => exportTableToExcel('inv-table')} className="bg-green-600 text-white px-3 py-1.5 rounded text-sm flex items-center gap-1"><Download size={16}/> Excel</button>
                            <button onClick={() => handleOpenModal()} className="bg-blue-600 text-white px-3 py-1.5 rounded text-sm flex items-center gap-1"><Plus size={16}/> Tambah</button>
                        </div>
                    </div>
                    <div className="overflow-x-auto">
                        <table id="inv-table" className="w-full text-sm text-left">
                            <thead className="bg-gray-50 uppercase text-xs">
                                <tr>
                                    <th className="p-3">Kode</th><th className="p-3">Nama Barang</th><th className="p-3">Qty (Stok)</th><th className="p-3">Satuan</th><th className="p-3">Harga</th><th className="p-3 text-right">Aksi</th>
                                </tr>
                            </thead>
                            <tbody>
                                {items.length === 0 ? <tr><td colSpan="6" className="p-4 text-center text-gray-400">Data kosong. Tambahkan barang.</td></tr> : items.map(item => (
                                    <tr key={item.id} className="border-b hover:bg-gray-50">
                                        <td className="p-3 font-mono text-blue-600 font-medium">{item.code || '-'}</td>
                                        <td className="p-3 font-medium">{item.name}</td>
                                        <td className="p-3"><span className={`font-bold ${item.stock <= (item.minStock || 5) ? 'text-red-600' : 'text-gray-700'}`}>{item.stock}</span></td>
                                        <td className="p-3 text-gray-500">{item.unit}</td>
                                        <td className="p-3 text-blue-600">{formatRupiah(item.price)}</td>
                                        <td className="p-3 text-right flex justify-end gap-2">
                                            <button onClick={() => handleOpenModal(item)} className="text-blue-500 bg-blue-50 p-1.5 rounded hover:bg-blue-100 transition"><Edit size={16} /></button>
                                            <button onClick={() => onDelete(item.id)} className="text-red-500 bg-red-50 p-1.5 rounded hover:bg-red-100 transition"><Trash2 size={16} /></button>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                    {isModalOpen && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
                            <div className="bg-white p-6 rounded-xl w-full max-w-sm shadow-2xl">
                                <h3 className="font-bold mb-4 flex items-center gap-2">{editingItem ? <Edit size={20} className="text-blue-600"/> : <Plus size={20} className="text-blue-600"/>} {editingItem ? 'Edit Barang' : 'Tambah Barang'}</h3>
                                <form onSubmit={handleSubmit} className="space-y-3">
                                    <div><label className="text-xs font-bold text-gray-500">Kode</label><div className="relative"><input value={formData.code} onChange={e => setFormData({...formData, code: e.target.value})} className="w-full border p-2 pl-8 rounded uppercase font-mono" required/><ScanBarcode className="absolute left-2 top-2 text-gray-400" size={16}/></div></div>
                                    <div><label className="text-xs font-bold text-gray-500">Nama</label><input value={formData.name} onChange={e => setFormData({...formData, name: e.target.value})} className="w-full border p-2 rounded" required /></div>
                                    <div className="grid grid-cols-2 gap-3">
                                        <div><label className="text-xs font-bold text-gray-500">Stok</label><input type="number" value={formData.stock} onChange={e => setFormData({...formData, stock: e.target.value})} className="w-full border p-2 rounded" required /></div>
                                        <div><label className="text-xs font-bold text-gray-500">Satuan</label><input value={formData.unit} onChange={e => setFormData({...formData, unit: e.target.value})} className="w-full border p-2 rounded" required /></div>
                                    </div>
                                    <div><label className="text-xs font-bold text-gray-500">Harga (Rp)</label><input type="number" value={formData.price} onChange={e => setFormData({...formData, price: e.target.value})} className="w-full border p-2 rounded" required /></div>
                                    <div className="pt-2 flex gap-2"><button type="button" onClick={() => setModalOpen(false)} className="flex-1 bg-gray-100 p-2 rounded">Batal</button><button type="submit" className="flex-1 bg-blue-600 text-white p-2 rounded">Simpan</button></div>
                                </form>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // --- ADMIN DASHBOARD ---
        const Dashboard = ({ items, requests, transactions }) => {
            const lowStockItems = items.filter(i => i.stock <= i.minStock);
            return (
                <div className="space-y-6">
                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <StatCard title="Total Item" value={items.length} icon={<Package className="text-blue-600" />} color="bg-blue-50" />
                        <StatCard title="Stok Menipis" value={lowStockItems.length} icon={<AlertTriangle className="text-orange-600" />} color="bg-orange-50" isWarning={true} />
                        <StatCard title="Total Transaksi" value={transactions.length} icon={<History className="text-purple-600" />} color="bg-purple-50" />
                        <StatCard title="Permintaan Pending" value={requests.filter(r => r.status === 'Pending').length} icon={<ShoppingCart className="text-indigo-600" />} color="bg-indigo-50" />
                    </div>
                </div>
            );
        };

        // --- REPORT COMPONENT ---
        const ReportView = ({ transactions, items, requests }) => {
            const [reportType, setReportType] = useState('inventory');
            const [selectedYear, setSelectedYear] = useState(new Date().getFullYear());
            const [selectedMonth, setSelectedMonth] = useState('all');
            const months = ["Jan", "Feb", "Mar", "Apr", "Mei", "Jun", "Jul", "Agt", "Sep", "Okt", "Nov", "Des"];
            const shortMonths = ["Jan", "Feb", "Mar", "Apr", "Mei", "Jun", "Jul", "Agt", "Sep", "Okt", "Nov", "Des"];

            const reportData = useMemo(() => {
                const itemMap = items.reduce((acc, item) => {
                    acc[item.name] = { code: item.code || '-', name: item.name, price: parseInt(item.price) || 0, unit: item.unit, monthlyOut: Array(12).fill(0), monthlyIn: Array(12).fill(0), totalIn: 0, totalOut: 0, totalInVal: 0 };
                    return acc;
                }, {});

                transactions.forEach(t => {
                    const tDate = new Date(t.date);
                    if (tDate.getFullYear() !== parseInt(selectedYear)) return;
                    const key = t.itemName;
                    if (!itemMap[key]) itemMap[key] = { code: 'DEL', name: key, price: 0, unit: '-', monthlyOut: Array(12).fill(0), monthlyIn: Array(12).fill(0), totalIn: 0, totalOut: 0, totalInVal: 0 };
                    const qty = parseInt(t.qty) || 0;
                    if (t.type === 'in') { itemMap[key].monthlyIn[tDate.getMonth()] += qty; itemMap[key].totalIn += qty; itemMap[key].totalInVal += (qty * itemMap[key].price); }
                    else if (t.type === 'out') { itemMap[key].monthlyOut[tDate.getMonth()] += qty; itemMap[key].totalOut += qty; }
                });

                const rows = Object.values(itemMap);
                if (selectedMonth !== 'all') {
                    const m = parseInt(selectedMonth);
                    return rows.map(r => ({ ...r, in: r.monthlyIn[m], out: r.monthlyOut[m], diff: r.monthlyIn[m] - r.monthlyOut[m], val: r.monthlyOut[m] * r.price, inVal: r.monthlyIn[m] * r.price })).filter(r => r.in > 0 || r.out > 0);
                }
                return rows.map(r => ({ ...r, val: r.totalOut * r.price, inVal: r.totalInVal })).filter(r => r.totalIn > 0 || r.totalOut > 0);
            }, [transactions, items, selectedYear, selectedMonth]);

            const deptReportData = useMemo(() => {
                const data = {};
                requests.forEach(req => {
                    if (req.status !== 'Approved') return;
                    const rDate = new Date(req.date);
                    if (rDate.getFullYear() !== parseInt(selectedYear)) return;
                    const m = rDate.getMonth();
                    const dept = req.department || 'Tanpa Dept';
                    if (!data[dept]) data[dept] = { name: dept, monthlyVal: Array(12).fill(0), monthlyCount: Array(12).fill(0), totalVal: 0, reqCount: 0 };
                    let val = 0;
                    req.items?.forEach(i => val += (parseInt(i.qty)||0) * (parseInt(i.price)||0));
                    data[dept].monthlyVal[m] += val; data[dept].monthlyCount[m]++; data[dept].totalVal += val; data[dept].reqCount++;
                });
                const rows = Object.values(data).sort((a,b) => b.totalVal - a.totalVal);
                if (selectedMonth !== 'all') {
                    const m = parseInt(selectedMonth);
                    return rows.map(r => ({ ...r, val: r.monthlyVal[m], count: r.monthlyCount[m] })).filter(r => r.count > 0);
                }
                return rows;
            }, [requests, selectedYear, selectedMonth]);

            const totalValueOut = reportData.reduce((acc, curr) => acc + (curr.val || 0), 0);
            const totalDeptValue = deptReportData.reduce((acc, curr) => acc + (selectedMonth !== 'all' ? curr.val : curr.totalVal), 0);

            return (
                <div className="bg-white p-6 rounded-xl shadow-sm border">
                    <div className="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                        <div>
                            <h2 className="text-xl font-bold text-gray-800 flex items-center gap-2"><BarChart3 size={24} className="text-blue-600"/> Laporan</h2>
                            <div className="flex gap-2 mt-2">
                                <button onClick={() => setReportType('inventory')} className={`px-3 py-1 text-xs font-bold rounded-full ${reportType === 'inventory' ? 'bg-blue-100 text-blue-700' : 'bg-gray-100 text-gray-500'}`}>Stok Barang</button>
                                <button onClick={() => setReportType('department')} className={`px-3 py-1 text-xs font-bold rounded-full ${reportType === 'department' ? 'bg-blue-100 text-blue-700' : 'bg-gray-100 text-gray-500'}`}>Per Departemen</button>
                            </div>
                        </div>
                        <div className="flex flex-wrap items-center gap-2 bg-gray-50 p-2 rounded-lg">
                            <select className="border rounded p-1.5 text-sm" value={selectedYear} onChange={(e) => setSelectedYear(e.target.value)}>{[...Array(5)].map((_, i) => { const y = new Date().getFullYear() - i; return <option key={y} value={y}>{y}</option> })}</select>
                            <select className="border rounded p-1.5 text-sm" value={selectedMonth} onChange={(e) => setSelectedMonth(e.target.value)}><option value="all">Semua Bulan</option>{months.map((m, i) => <option key={i} value={i}>{m}</option>)}</select>
                            <button onClick={() => exportTableToExcel('report-tbl')} className="bg-green-600 text-white p-1.5 rounded flex items-center gap-1 text-xs font-bold"><Download size={16}/> Excel</button>
                        </div>
                    </div>
                    
                    <div className="overflow-x-auto mb-6">
                        <table id="report-tbl" className="w-full text-sm text-left">
                            <thead className="bg-gray-50 uppercase text-xs">
                                {reportType === 'inventory' ? (
                                    selectedMonth !== 'all' ? 
                                    <tr><th className="p-3">Kode</th><th className="p-3">Nama</th><th className="p-3 text-center">Masuk</th><th className="p-3 text-center">Keluar</th><th className="p-3 text-right">Nilai Masuk</th><th className="p-3 text-right">Nilai Keluar</th></tr> :
                                    <tr><th className="p-3">Nama</th><th className="p-3 text-center">Total In</th><th className="p-3 text-center">Total Out</th><th className="p-3 text-right">Nilai In</th><th className="p-3 text-right">Nilai Out</th></tr>
                                ) : (
                                    <tr><th className="p-3">Departemen</th><th className="p-3 text-center">Jumlah Req</th><th className="p-3 text-right">Total Nilai</th></tr>
                                )}
                            </thead>
                            <tbody>
                                {reportType === 'inventory' ? reportData.map((row, i) => (
                                    <tr key={i} className="border-b">
                                        {selectedMonth !== 'all' ? <>
                                            <td className="p-3 font-mono text-xs">{row.code}</td><td className="p-3">{row.name}</td>
                                            <td className="p-3 text-center text-green-600">{row.in}</td><td className="p-3 text-center text-red-600">{row.out}</td>
                                            <td className="p-3 text-right text-green-600">{formatRupiah(row.inVal)}</td><td className="p-3 text-right text-red-600">{formatRupiah(row.val)}</td>
                                        </> : <>
                                            <td className="p-3">{row.name}</td>
                                            <td className="p-3 text-center">{row.totalIn}</td><td className="p-3 text-center">{row.totalOut}</td>
                                            <td className="p-3 text-right text-green-600">{formatRupiah(row.totalInVal)}</td><td className="p-3 text-right text-red-600">{formatRupiah(row.val)}</td>
                                        </>}
                                    </tr>
                                )) : deptReportData.map((row, i) => (
                                    <tr key={i} className="border-b">
                                        <td className="p-3">{row.name}</td>
                                        <td className="p-3 text-center">{selectedMonth !== 'all' ? row.count : row.reqCount}</td>
                                        <td className="p-3 text-right text-blue-600">{formatRupiah(selectedMonth !== 'all' ? row.val : row.totalVal)}</td>
                                    </tr>
                                ))}
                            </tbody>
                            <tfoot className="bg-gray-100 font-bold">
                                {reportType === 'inventory' ? (
                                    <tr><td colSpan={selectedMonth !== 'all' ? 4 : 4} className="p-3 text-right">TOTAL KELUAR:</td><td className="p-3 text-right">{formatRupiah(totalValueOut)}</td></tr>
                                ) : (
                                    <tr><td colSpan="2" className="p-3 text-right">TOTAL:</td><td className="p-3 text-right">{formatRupiah(totalDeptValue)}</td></tr>
                                )}
                            </tfoot>
                        </table>
                    </div>
                </div>
            );
        };

        // --- ADMIN REQUESTS ---
        const Requests = ({ requests, onApprove, onReject }) => (
          <div className="space-y-4">
            {requests.filter(r => r.status === 'Pending').length === 0 ? <p className="text-gray-400">Tidak ada data baru</p> : 
            requests.filter(r => r.status === 'Pending').map(req => (
               <div key={req.id} className="bg-white p-4 rounded shadow border-l-4 border-blue-400">
                  <div className="flex justify-between items-start">
                     <div>
                        <p className="font-bold">{req.userName} <span className="font-normal text-gray-500">({req.department})</span></p>
                        <ul className="text-sm list-disc pl-4 mt-1">{req.items && req.items.map((i,idx) => <li key={idx}>[{i.code}] {i.name} x{i.qty}</li>)}</ul>
                     </div>
                     <div className="flex gap-2">
                        <button onClick={() => onReject(req.id)} className="text-red-500 border border-red-200 px-3 py-1 rounded text-sm">Tolak</button>
                        <button onClick={() => onApprove(req.id)} className="bg-blue-600 text-white px-3 py-1 rounded text-sm">Setujui</button>
                     </div>
                  </div>
               </div>
            ))}
          </div>
        );

        // --- ADMIN HISTORY ---
        const HistoryView = ({ transactions }) => (
           <div className="bg-white p-4 rounded shadow">
              <h3 className="font-bold mb-4">Riwayat Transaksi</h3>
              <div className="overflow-x-auto"><table className="w-full text-sm"><thead><tr className="border-b text-left"><th className="pb-2">Tanggal</th><th className="pb-2">Barang</th><th className="pb-2">Ket</th></tr></thead><tbody>{transactions.length === 0 ? <tr><td colSpan="3" className="py-2 text-gray-400 text-center">Kosong</td></tr> : transactions.map(t => <tr key={t.id} className="border-b"><td className="py-2">{t.date}</td><td className="py-2">{String(t.itemName)} ({t.qty})</td><td className="py-2 text-gray-500">{String(t.requester)}</td></tr>)}</tbody></table></div>
           </div>
        );

        // --- MAIN APP COMPONENT ---
        function App() {
            const [user, setUser] = useState(null);
            const [items, setItems] = useState([]);
            const [transactions, setTransactions] = useState([]);
            const [requests, setRequests] = useState([]);
            const [activeRole, setActiveRole] = useState('admin');
            const [activeView, setActiveView] = useState('dashboard');
            const [isSidebarOpen, setSidebarOpen] = useState(false);
            const [notification, setNotification] = useState(null);

            const showNotification = (msg, type = 'success') => {
                setNotification({ message: msg, type });
                setTimeout(() => setNotification(null), 3000);
            };

            useEffect(() => {
                const init = async () => {
                    try { await signInAnonymously(auth); } catch (e) { console.error(e); }
                };
                init();
                return onAuthStateChanged(auth, setUser);
            }, []);

            useEffect(() => {
                if (!user) return;
                const unsubItems = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'items'), s => setItems(s.docs.map(d => ({id:d.id, ...d.data()})).sort((a,b)=>(a.name||'').localeCompare(b.name||''))));
                const unsubReq = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'requests'), s => setRequests(s.docs.map(d => ({id:d.id, ...d.data()})).sort((a,b)=>new Date(b.createdAt||b.date)-new Date(a.createdAt||a.date))));
                const unsubTrans = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'transactions'), s => setTransactions(s.docs.map(d => ({id:d.id, ...d.data()})).sort((a,b)=>new Date(b.createdAt||b.date)-new Date(a.createdAt||a.date))));
                return () => { unsubItems(); unsubReq(); unsubTrans(); };
            }, [user]);

            const handleAddItem = async (item) => {
                try {
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'items'), {...item, createdAt: new Date().toISOString()});
                    if (item.stock > 0) {
                         await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'transactions'), {
                            date: new Date().toISOString().split('T')[0], createdAt: new Date().toISOString(), type: 'in', itemName: item.name, qty: item.stock, requester: 'Initial Stock'
                         });
                    }
                    showNotification('Tersimpan');
                } catch (e) { showNotification('Gagal', 'error'); }
            };

            const handleUpdateItem = async (item) => { try { await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'items', item.id), item); showNotification('Updated'); } catch (e) { showNotification('Gagal', 'error'); } };
            const handleDeleteItem = async (id) => { if(confirm('Hapus?')) try { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'items', id)); showNotification('Terhapus'); } catch (e) { showNotification('Gagal', 'error'); } };
            
            const handleApprove = async (reqId) => {
                const req = requests.find(r => r.id === reqId);
                if(!req) return;
                try {
                    for(const item of req.items) {
                        if(item.type === 'master') {
                            const dbItem = items.find(x => x.id === item.itemId);
                            if(dbItem) await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'items', dbItem.id), {stock: dbItem.stock - item.qty});
                        }
                    }
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'requests', reqId), {status: 'Approved'});
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'transactions'), {
                        date: new Date().toISOString().split('T')[0], createdAt: new Date().toISOString(), type: 'out',
                        itemName: req.items[0].name, qty: req.items.reduce((a,b)=>a+parseInt(b.qty),0), requester: req.userName
                    });
                    showNotification('Disetujui');
                } catch(e) { showNotification('Error', 'error'); }
            };

            const handleReject = async (reqId) => { try { await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'requests', reqId), {status: 'Rejected'}); showNotification('Ditolak'); } catch(e) { showNotification('Error', 'error'); } };

            return (
                <div className="flex h-screen bg-gray-50 text-gray-800 font-sans overflow-hidden">
                    <aside 
                        className={`bg-slate-900 text-white transition-all duration-300 ease-in-out flex flex-col shadow-xl z-20 absolute md:relative h-full ${isSidebarOpen ? 'w-64' : 'w-0 md:w-20'}`}
                        onMouseEnter={() => window.innerWidth >= 768 && setSidebarOpen(true)}
                        onMouseLeave={() => window.innerWidth >= 768 && setSidebarOpen(false)}
                    >
                        <div className="p-4 border-b border-slate-700 flex justify-between items-center">
                             {(isSidebarOpen || window.innerWidth >= 768) && <h1 className={`font-bold text-xl tracking-wider text-blue-400 whitespace-nowrap transition-opacity duration-300 ${isSidebarOpen ? 'opacity-100' : 'md:opacity-0'}`}>ATK INV</h1>}
                            <button onClick={() => setSidebarOpen(!isSidebarOpen)} className="p-1 hover:bg-slate-700 rounded md:hidden"><X size={20}/></button>
                        </div>
                        <nav className="flex-1 py-6 space-y-1 overflow-y-auto no-scrollbar">
                            <NavItem icon={<LayoutDashboard size={20}/>} label="Dashboard" isActive={activeView==='dashboard'} onClick={()=>{setActiveView('dashboard');setSidebarOpen(false)}} isOpen={isSidebarOpen}/>
                            <NavItem icon={<Package size={20}/>} label="Stok Barang" isActive={activeView==='inventory'} onClick={()=>{setActiveView('inventory');setSidebarOpen(false)}} isOpen={isSidebarOpen}/>
                            <NavItem icon={<ShoppingCart size={20}/>} label="Permintaan" isActive={activeView==='requests'} onClick={()=>{setActiveView('requests');setSidebarOpen(false)}} isOpen={isSidebarOpen} count={requests.filter(r=>r.status==='Pending').length}/>
                            <NavItem icon={<BarChart3 size={20}/>} label="Laporan" isActive={activeView==='report'} onClick={()=>{setActiveView('report');setSidebarOpen(false)}} isOpen={isSidebarOpen}/>
                            <NavItem icon={<History size={20}/>} label="Riwayat" isActive={activeView==='history'} onClick={()=>{setActiveView('history');setSidebarOpen(false)}} isOpen={isSidebarOpen}/>
                            <NavItem icon={<Info size={20}/>} label="Informasi" isActive={activeView==='info'} onClick={()=>{setActiveView('info');setSidebarOpen(false)}} isOpen={isSidebarOpen}/>
                        </nav>
                        <div className="p-4 border-t border-slate-700">
                            <div className="flex items-center justify-center">
                                <div className={`w-8 h-8 rounded-full flex items-center justify-center font-bold ${activeRole === 'admin' ? 'bg-blue-500' : 'bg-orange-500'}`}>{activeRole === 'admin' ? 'A' : 'U'}</div>
                            </div>
                        </div>
                    </aside>
                    
                    <main className="flex-1 flex flex-col overflow-hidden relative w-full">
                        <header className="h-16 bg-white border-b flex items-center justify-between px-4 md:px-6 shadow-sm z-10 shrink-0">
                            <div className="flex items-center gap-4">
                                <button onClick={() => setSidebarOpen(!isSidebarOpen)} className="md:hidden p-1 text-gray-600"><Menu size={24}/></button>
                                <h2 className="text-lg font-semibold text-gray-700">Admin Panel</h2>
                            </div>
                        </header>
                        
                        <div className="flex-1 overflow-auto p-4 md:p-6 bg-gray-50">
                           {activeView === 'dashboard' && <Dashboard items={items} requests={requests} transactions={transactions}/>}
                           {activeView === 'inventory' && <Inventory items={items} onAdd={handleAddItem} onUpdate={handleUpdateItem} onDelete={handleDeleteItem}/>}
                           {activeView === 'requests' && <Requests requests={requests} onApprove={handleApprove} onReject={handleReject}/>}
                           {activeView === 'report' && <ReportView transactions={transactions} items={items} requests={requests}/>}
                           {activeView === 'history' && <HistoryView transactions={transactions}/>}
                           {activeView === 'info' && <InformationView db={db} appId={appId} itemsCount={items.length} transactionsCount={transactions.length} requestsCount={requests.length} />}
                        </div>
                        <footer className="bg-white border-t py-3 px-6 text-center text-xs text-gray-400">
                            &copy; 2026 Direktorat Operation - Dept Operational Support
                        </footer>
                    </main>
                    
                    {notification && <div className={`fixed bottom-5 right-5 px-6 py-3 rounded-lg shadow-lg text-white z-50 ${notification.type === 'error' ? 'bg-red-500' : 'bg-green-600'}`}>{notification.message}</div>}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(React.createElement(App));
    </script>
</body>
</html>
