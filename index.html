<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sistem Inventaris ATK</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Babel untuk JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none;  scrollbar-width: none; }
        
        @media print {
            body * { visibility: hidden; }
            #print-area, #print-area * { visibility: visible; }
            #print-area { position: absolute; left: 0; top: 0; width: 100%; margin: 0; padding: 0; }
            .print\:hidden { display: none !important; }
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">
    <div id="root"></div>

    <!-- Script Utama dengan type="text/babel" -->
    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef, useMemo } from 'https://esm.sh/react@18.2.0';
        import ReactDOM from 'https://esm.sh/react-dom@18.2.0/client';
        import { 
            LayoutDashboard, Package, ShoppingCart, History, Menu, Plus, Search, Trash2, Edit, Check, X, 
            AlertTriangle, ArrowUpRight, ArrowDownLeft, Banknote, FileText, Printer, Camera, Upload, Save, 
            Eraser, Users, Wifi, WifiOff, Calendar, ClipboardList, LogOut, ScanBarcode, QrCode, Tag, 
            BarChart3, TrendingUp, Filter, Building2, Download
        } from 'https://esm.sh/lucide-react@0.303.0';

        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { 
            getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy, serverTimestamp 
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { 
            getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // --- CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyAn5SPEUZO8sIoYSL0YvRON80C-OzS7odA",
            authDomain: "stock-atk-2a300.firebaseapp.com",
            projectId: "stock-atk-2a300",
            storageBucket: "stock-atk-2a300.firebasestorage.app",
            messagingSenderId: "800795365519",
            appId: "1:800795365519:web:766e630bd962235ba8e0fa"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const appId = 'stock-atk-prod'; 

        // --- HELPERS ---
        const formatRupiah = (number) => {
            const val = Number(number) || 0;
            return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(val);
        };

        const exportTableToExcel = (tableId, filename = 'download.xls') => {
            const table = document.getElementById(tableId);
            if (!table) return;
            const html = table.outerHTML;
            const blob = new Blob([`
                <html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:x='urn:schemas-microsoft-com:office:excel' xmlns='http://www.w3.org/TR/REC-html40'>
                <head><meta charset='utf-8'></head><body>${html}</body></html>
            `], { type: 'application/vnd.ms-excel' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        };

        // --- COMPONENTS ---

        const NavItem = ({ icon, label, isActive, onClick, isOpen, count }) => (
            <button onClick={onClick} className={`w-full flex items-center px-4 py-3 transition-colors ${isActive ? 'bg-slate-800 border-r-4 border-blue-500 text-blue-400' : 'text-slate-300 hover:bg-slate-800'}`}>
                <span className="mr-3">{icon}</span>
                {isOpen && <span className="flex-1 text-left text-sm font-medium whitespace-nowrap">{label}</span>}
                {isOpen && count > 0 && <span className="bg-red-500 text-white text-xs px-2 py-0.5 rounded-full">{count}</span>}
            </button>
        );

        const StatCard = ({ title, value, icon, color, isWarning }) => (
            <div className={`p-4 rounded-xl shadow-sm border border-gray-100 flex items-center justify-between ${isWarning ? 'ring-2 ring-red-100' : ''} bg-white`}>
                <div><p className="text-xs font-medium text-gray-500">{title}</p><h3 className="text-xl font-bold mt-1">{value}</h3></div>
                <div className={`p-2 rounded-lg ${color}`}>{icon}</div>
            </div>
        );

        class SignaturePad extends React.Component {
            constructor(props) {
                super(props);
                this.canvasRef = React.createRef();
                this.isDrawing = false;
                this.hasContent = false;
                this.ctx = null;
            }

            componentDidMount() {
                this.initCanvas();
                window.addEventListener('resize', this.handleResize);
            }

            componentWillUnmount() {
                window.removeEventListener('resize', this.handleResize);
            }

            initCanvas = () => {
                const canvas = this.canvasRef.current;
                if (!canvas) return;
                const rect = canvas.getBoundingClientRect();
                canvas.width = rect.width;
                canvas.height = rect.height;
                this.ctx = canvas.getContext('2d');
                this.setupContext();
            }

            setupContext = () => {
                if (this.ctx) {
                    this.ctx.lineWidth = 2;
                    this.ctx.lineCap = 'round';
                    this.ctx.lineJoin = 'round';
                    this.ctx.strokeStyle = '#000000';
                }
            }

            handleResize = () => this.initCanvas();

            startDrawing = (e) => {
                const { offsetX, offsetY } = this.getCoordinates(e);
                this.ctx.beginPath();
                this.ctx.moveTo(offsetX, offsetY);
                this.isDrawing = true;
                this.hasContent = true;
            }

            draw = (e) => {
                if (!this.isDrawing) return;
                const { offsetX, offsetY } = this.getCoordinates(e);
                this.ctx.lineTo(offsetX, offsetY);
                this.ctx.stroke();
            }

            stopDrawing = () => {
                if (this.isDrawing) {
                    this.ctx.closePath();
                    this.isDrawing = false;
                }
            }

            getCoordinates = (e) => {
                const canvas = this.canvasRef.current;
                const rect = canvas.getBoundingClientRect();
                let clientX, clientY;
                if (e.touches && e.touches.length > 0) {
                    clientX = e.touches[0].clientX;
                    clientY = e.touches[0].clientY;
                } else {
                    clientX = e.clientX;
                    clientY = e.clientY;
                }
                return { offsetX: clientX - rect.left, offsetY: clientY - rect.top };
            }

            clear = () => {
                const canvas = this.canvasRef.current;
                this.ctx.clearRect(0, 0, canvas.width, canvas.height);
                this.hasContent = false;
            }

            isEmpty = () => !this.hasContent;
            getTrimmedCanvas = () => this.canvasRef.current;

            render() {
                return (
                    <canvas
                        ref={this.canvasRef}
                        className="w-full h-full cursor-crosshair block touch-none"
                        onMouseDown={this.startDrawing}
                        onMouseMove={this.draw}
                        onMouseUp={this.stopDrawing}
                        onMouseLeave={this.stopDrawing}
                        onTouchStart={this.startDrawing}
                        onTouchMove={this.draw}
                        onTouchEnd={this.stopDrawing}
                    />
                );
            }
        }

        const PrintView = ({ data, onClose }) => {
            const isWithdrawal = data.type === 'withdrawal';
            const title = isWithdrawal ? 'Formulir Pengambilan Barang' : 'Formulir Permintaan Barang';
            const docCode = isWithdrawal ? 'OUT' : 'REQ';

            return (
                <div className="fixed inset-0 bg-gray-800 z-50 overflow-auto flex flex-col items-center pt-10 pb-10">
                    <div className="bg-white w-[210mm] min-h-[297mm] p-[10mm] md:p-[20mm] shadow-2xl relative text-black text-sm md:text-base" id="print-area">
                        <div className="border-b-4 border-black pb-4 mb-6 flex justify-between items-end">
                            <div>
                                <h1 className="text-2xl md:text-3xl font-bold uppercase tracking-wider">{title}</h1>
                                <p className="mt-1">No: {docCode}/{data.id ? data.id.slice(0, 8) : 'DRAFT'}/{new Date().getFullYear()}</p>
                            </div>
                            <div className="text-right">
                                <p className="font-bold text-lg uppercase">DEPARTEMEN {data.department}</p>
                                <p className="text-xs">Dokumen Internal</p>
                            </div>
                        </div>

                        <div className="mb-6 grid grid-cols-2 gap-x-8 gap-y-2">
                            <div className="flex"><span className="w-24 font-bold">Tanggal</span><span>: {data.date}</span></div>
                            <div className="flex"><span className="w-24 font-bold">Periode</span><span>: {data.period || '-'}</span></div>
                            <div className="flex"><span className="w-24 font-bold">Departemen</span><span>: {data.department}</span></div>
                            <div className="flex"><span className="w-24 font-bold">Nama</span><span>: {data.userName}</span></div>
                            <div className="flex"><span className="w-24 font-bold">Status</span><span className="uppercase font-bold">: {data.status}</span></div>
                        </div>

                        <div className="mb-8">
                            <table className="w-full border-collapse border border-black text-sm">
                                <thead>
                                    <tr className="bg-gray-200">
                                        <th className="border border-black px-2 py-2 w-10">No</th>
                                        <th className="border border-black px-2 py-2 text-left">Kode</th>
                                        <th className="border border-black px-2 py-2 text-left">Nama Barang</th>
                                        <th className="border border-black px-2 py-2 w-16">Qty</th>
                                        <th className="border border-black px-2 py-2">Unit</th>
                                        <th className="border border-black px-2 py-2">Harga</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {data.items && data.items.map((item, idx) => (
                                        <tr key={idx}>
                                            <td className="border border-black px-2 py-2 text-center">{idx + 1}</td>
                                            <td className="border border-black px-2 py-2 font-mono text-xs">{item.code || '-'}</td>
                                            <td className="border border-black px-2 py-2">{item.name} {item.type === 'manual' && '*'}</td>
                                            <td className="border border-black px-2 py-2 text-center font-bold">{Number(item.qty)}</td>
                                            <td className="border border-black px-2 py-2 text-center">{item.unit || 'Pcs'}</td>
                                            <td className="border border-black px-2 py-2 text-center">{formatRupiah(item.price || 0)}</td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>

                        <div className="flex justify-between mt-12 px-4 md:px-10">
                            <div className="text-center">
                                <p className="mb-12 font-bold">{isWithdrawal ? 'Diambil Oleh,' : 'Diajukan Oleh,'}</p>
                                {data.signature ? <img src={data.signature} className="h-16 mx-auto -mt-8 mb-2" /> : <div className="h-16"></div>}
                                <p className="font-bold underline">{data.userName}</p>
                                <p className="text-sm">Staff {data.department}</p>
                            </div>
                            <div className="text-center">
                                <p className="mb-12 font-bold">Disetujui Oleh,</p>
                                <div className="h-16"></div>
                                <p className="font-bold underline">__________________</p>
                                <p className="text-sm">Manager / Kepala Bagian</p>
                            </div>
                        </div>
                    </div>
                    <div className="fixed top-5 right-5 flex gap-3 print:hidden">
                        <button onClick={onClose} className="bg-gray-600 text-white px-4 py-2 rounded shadow flex items-center gap-2"><X size={18} /> Tutup</button>
                        <button onClick={() => window.print()} className="bg-blue-600 text-white px-6 py-2 rounded shadow flex items-center gap-2 font-bold"><Printer size={18} /> Cetak</button>
                    </div>
                </div>
            );
        };

        // --- MAIN APP ---
        function App() {
            const [user, setUser] = useState(null);
            const [items, setItems] = useState([]);
            const [transactions, setTransactions] = useState([]);
            const [requests, setRequests] = useState([]);
            const [activeRole, setActiveRole] = useState('admin');
            const [activeView, setActiveView] = useState('dashboard');
            const [isSidebarOpen, setSidebarOpen] = useState(false);
            const [notification, setNotification] = useState(null);
            const [printData, setPrintData] = useState(null);

            // Report State
            const [reportType, setReportType] = useState('inventory');
            const [selectedYear, setSelectedYear] = useState(new Date().getFullYear());
            const [selectedMonth, setSelectedMonth] = useState('all');

            // User Form State
            const [formName, setFormName] = useState('');
            const [formDept, setFormDept] = useState('');
            const [isManualDept, setIsManualDept] = useState(false);
            const [formDate, setFormDate] = useState(new Date().toISOString().split('T')[0]);
            const [formPeriod, setFormPeriod] = useState('');
            const [inputMode, setInputMode] = useState('master');
            const [selectedItemId, setSelectedItemId] = useState('');
            const [formQty, setFormQty] = useState(1);
            const [scanCode, setScanCode] = useState('');
            const [manualName, setManualName] = useState('');
            const [manualPhoto, setManualPhoto] = useState(null);
            const [requestList, setRequestList] = useState([]);
            const sigCanvas = useRef(null);
            const scanInputRef = useRef(null);

            const showNotification = (msg, type = 'success') => {
                setNotification({ message: msg, type });
                setTimeout(() => setNotification(null), 3000);
            };

            useEffect(() => {
                const init = async () => {
                    try { await signInAnonymously(auth); } catch (e) { console.error(e); }
                };
                init();
                return onAuthStateChanged(auth, setUser);
            }, []);

            useEffect(() => {
                if (!user) return;
                const unsub1 = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'items'), s => setItems(s.docs.map(d => ({id:d.id, ...d.data()})).sort((a,b)=>(a.name||'').localeCompare(b.name||''))));
                const unsub2 = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'requests'), s => setRequests(s.docs.map(d => ({id:d.id, ...d.data()})).sort((a,b)=>new Date(b.createdAt||b.date)-new Date(a.createdAt||a.date))));
                const unsub3 = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'transactions'), s => setTransactions(s.docs.map(d => ({id:d.id, ...d.data()})).sort((a,b)=>new Date(b.createdAt||b.date)-new Date(a.createdAt||a.date))));
                return () => { unsub1(); unsub2(); unsub3(); };
            }, [user]);

            const handleAddItem = async (item) => {
                try {
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'items'), {...item, createdAt: new Date().toISOString()});
                    if (item.stock > 0) {
                         await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'transactions'), {
                            date: new Date().toISOString().split('T')[0], createdAt: new Date().toISOString(), type: 'in', itemName: item.name, qty: item.stock, requester: 'Initial Stock'
                         });
                    }
                    showNotification('Tersimpan');
                } catch (e) { showNotification('Gagal', 'error'); }
            };
            
            const handleUserSubmit = async (type) => {
                if (!formName || !formDept) return alert('Lengkapi data diri');
                if (requestList.length === 0) return alert('Keranjang kosong');
                let sig = null;
                if (sigCanvas.current && !sigCanvas.current.isEmpty()) sig = sigCanvas.current.getTrimmedCanvas().toDataURL('image/png');
                if (!sig) return alert('Tanda tangan wajib');

                try {
                    const processedItems = await Promise.all(requestList.map(async item => {
                        if (item.type === 'manual') {
                            const exists = items.find(i => i.name.toLowerCase() === item.name.toLowerCase());
                            if (exists) return { ...item, type:'master', itemId: exists.id, code: exists.code, price: exists.price };
                            const newCode = `MAN-${Date.now().toString().slice(-6)}`;
                            const ref = await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'items'), {
                                name: item.name, code: newCode, stock: 0, unit: 'Pcs', price: 0, category: 'Umum', createdAt: new Date().toISOString()
                            });
                            return { ...item, type:'master', itemId: ref.id, code: newCode, price: 0 };
                        }
                        return item;
                    }));

                    const payload = {
                        type, date: formDate, period: type === 'withdrawal' ? '-' : formPeriod,
                        userId: user.uid, userName: formName, department: formDept, items: processedItems, signature: sig, status: 'Pending', createdAt: new Date().toISOString()
                    };
                    const docRef = await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'requests'), payload);
                    setPrintData({ id: docRef.id, ...payload });
                    setRequestList([]); setFormName(''); setFormDept('');
                    showNotification('Berhasil!');
                } catch (e) { showNotification('Error', 'error'); }
            };

            const handleScan = (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    const item = items.find(i => (i.code && i.code.toLowerCase() === scanCode.toLowerCase()) || (i.name && i.name.toLowerCase() === scanCode.toLowerCase()));
                    if (item) {
                        setRequestList([...requestList, { type:'master', itemId: item.id, code: item.code||'-', name: item.name, qty: parseInt(formQty)||1, price: item.price||0, unit: item.unit||'-' }]);
                        setScanCode(''); setFormQty(1);
                    } else alert('Barang tidak ditemukan');
                }
            };

            const handleAddToCart = () => {
                if (inputMode === 'master') {
                    const item = items.find(i => i.id === selectedItemId);
                    if (!item) return alert('Pilih barang');
                    setRequestList([...requestList, { type:'master', itemId: item.id, code: item.code||'-', name: item.name, qty: parseInt(formQty)||1, price: item.price||0, unit: item.unit||'-' }]);
                } else if (inputMode === 'manual') {
                    if(!manualName) return alert('Isi nama');
                    setRequestList([...requestList, { type:'manual', name: manualName, code: 'MANUAL', qty: parseInt(formQty)||1, price: 0, photo: manualPhoto }]);
                }
                setSelectedItemId(''); setManualName(''); setFormQty(1);
            };

            // Report Data Logic
            const reportData = useMemo(() => {
                const itemMap = items.reduce((acc, item) => {
                    acc[item.name] = { code: item.code || '-', name: item.name, price: parseInt(item.price) || 0, unit: item.unit, monthlyOut: Array(12).fill(0), monthlyIn: Array(12).fill(0), totalIn: 0, totalOut: 0, totalInVal: 0 };
                    return acc;
                }, {});

                transactions.forEach(t => {
                    const tDate = new Date(t.date);
                    if (tDate.getFullYear() !== parseInt(selectedYear)) return;
                    const key = t.itemName;
                    if (!itemMap[key]) itemMap[key] = { code: 'DEL', name: key, price: 0, unit: '-', monthlyOut: Array(12).fill(0), monthlyIn: Array(12).fill(0), totalIn: 0, totalOut: 0, totalInVal: 0 };
                    const qty = parseInt(t.qty) || 0;
                    if (t.type === 'in') { itemMap[key].monthlyIn[tDate.getMonth()] += qty; itemMap[key].totalIn += qty; itemMap[key].totalInVal += (qty * itemMap[key].price); }
                    else if (t.type === 'out') { itemMap[key].monthlyOut[tDate.getMonth()] += qty; itemMap[key].totalOut += qty; }
                });

                const rows = Object.values(itemMap);
                if (selectedMonth !== 'all') {
                    const m = parseInt(selectedMonth);
                    return rows.map(r => ({ ...r, in: r.monthlyIn[m], out: r.monthlyOut[m], diff: r.monthlyIn[m] - r.monthlyOut[m], val: r.monthlyOut[m] * r.price, inVal: r.monthlyIn[m] * r.price })).filter(r => r.in > 0 || r.out > 0);
                }
                return rows.map(r => ({ ...r, val: r.totalOut * r.price, inVal: r.totalInVal })).filter(r => r.totalIn > 0 || r.totalOut > 0);
            }, [transactions, items, selectedYear, selectedMonth]);

            const deptReportData = useMemo(() => {
                const data = {};
                requests.forEach(req => {
                    if (req.status !== 'Approved') return;
                    const rDate = new Date(req.date);
                    if (rDate.getFullYear() !== parseInt(selectedYear)) return;
                    const m = rDate.getMonth();
                    const dept = req.department || 'Tanpa Dept';
                    if (!data[dept]) data[dept] = { name: dept, monthlyVal: Array(12).fill(0), monthlyCount: Array(12).fill(0), totalVal: 0, reqCount: 0 };
                    let val = 0;
                    req.items?.forEach(i => val += (parseInt(i.qty)||0) * (parseInt(i.price)||0));
                    data[dept].monthlyVal[m] += val; data[dept].monthlyCount[m]++; data[dept].totalVal += val; data[dept].reqCount++;
                });
                const rows = Object.values(data).sort((a,b) => b.totalVal - a.totalVal);
                if (selectedMonth !== 'all') {
                    const m = parseInt(selectedMonth);
                    return rows.map(r => ({ ...r, val: r.monthlyVal[m], count: r.monthlyCount[m] })).filter(r => r.count > 0);
                }
                return rows;
            }, [requests, selectedYear, selectedMonth]);

            // Totals
            const totalValueOut = reportData.reduce((acc, curr) => acc + (curr.val || 0), 0);
            const totalValueIn = reportData.reduce((acc, curr) => acc + (curr.inVal || 0), 0);
            const totalQtyIn = reportData.reduce((acc, curr) => acc + (selectedMonth !== 'all' ? curr.in : curr.totalIn), 0);
            const totalQtyOut = reportData.reduce((acc, curr) => acc + (selectedMonth !== 'all' ? curr.out : curr.totalOut), 0);
            const totalDeptValue = deptReportData.reduce((acc, curr) => acc + (selectedMonth !== 'all' ? curr.val : curr.totalVal), 0);

            if (printData) return <PrintView data={printData} onClose={() => setPrintData(null)} />;

            return (
                <div className="flex h-screen bg-gray-50 text-gray-800 font-sans overflow-hidden">
                    <aside 
                        className={`bg-slate-900 text-white transition-all duration-300 ease-in-out flex flex-col shadow-xl z-20 absolute md:relative h-full ${isSidebarOpen ? 'w-64' : 'w-0 md:w-20'}`}
                        onMouseEnter={() => window.innerWidth >= 768 && setSidebarOpen(true)}
                        onMouseLeave={() => window.innerWidth >= 768 && setSidebarOpen(false)}
                    >
                        <div className="p-4 border-b border-slate-700 flex justify-between items-center">
                             {(isSidebarOpen || window.innerWidth >= 768) && <h1 className={`font-bold text-xl tracking-wider text-blue-400 whitespace-nowrap transition-opacity duration-300 ${isSidebarOpen ? 'opacity-100' : 'md:opacity-0'}`}>ATK INV</h1>}
                            <button onClick={() => setSidebarOpen(!isSidebarOpen)} className="p-1 hover:bg-slate-700 rounded md:hidden"><X size={20}/></button>
                        </div>
                        <nav className="flex-1 py-6 space-y-1 overflow-y-auto no-scrollbar">
                            {activeRole === 'admin' ? 
                                <>
                                    <NavItem icon={<LayoutDashboard size={20}/>} label="Dashboard" isActive={activeView==='dashboard'} onClick={()=>{setActiveView('dashboard');setSidebarOpen(false)}} isOpen={isSidebarOpen}/>
                                    <NavItem icon={<Package size={20}/>} label="Stok Barang" isActive={activeView==='inventory'} onClick={()=>{setActiveView('inventory');setSidebarOpen(false)}} isOpen={isSidebarOpen}/>
                                    <NavItem icon={<ShoppingCart size={20}/>} label="Permintaan" isActive={activeView==='requests'} onClick={()=>{setActiveView('requests');setSidebarOpen(false)}} isOpen={isSidebarOpen} count={requests.filter(r=>r.status==='Pending').length}/>
                                    <NavItem icon={<BarChart3 size={20}/>} label="Laporan" isActive={activeView==='report'} onClick={()=>{setActiveView('report');setSidebarOpen(false)}} isOpen={isSidebarOpen}/>
                                    <NavItem icon={<History size={20}/>} label="Riwayat" isActive={activeView==='history'} onClick={()=>{setActiveView('history');setSidebarOpen(false)}} isOpen={isSidebarOpen}/>
                                </> : 
                                <>
                                    <NavItem icon={<FileText size={20}/>} label="Permintaan" isActive={activeView==='user-form'} onClick={()=>{setActiveView('user-form');setSidebarOpen(false)}} isOpen={isSidebarOpen}/>
                                    <NavItem icon={<ClipboardList size={20}/>} label="Pengambilan" isActive={activeView==='user-withdrawal'} onClick={()=>{setActiveView('user-withdrawal');setSidebarOpen(false)}} isOpen={isSidebarOpen}/>
                                    <NavItem icon={<History size={20}/>} label="Riwayat Saya" isActive={activeView==='user-transactions'} onClick={()=>{setActiveView('user-transactions');setSidebarOpen(false)}} isOpen={isSidebarOpen}/>
                                </>
                            }
                        </nav>
                        <div className="p-4 border-t border-slate-700">
                            <div className="flex items-center justify-center">
                                <div className={`w-8 h-8 rounded-full flex items-center justify-center font-bold ${activeRole === 'admin' ? 'bg-blue-500' : 'bg-orange-500'}`}>{activeRole === 'admin' ? 'A' : 'U'}</div>
                            </div>
                        </div>
                    </aside>
                    
                    <main className="flex-1 flex flex-col overflow-hidden relative w-full">
                        <header className="h-16 bg-white border-b flex items-center justify-between px-4 md:px-6 shadow-sm z-10 shrink-0">
                            <div className="flex items-center gap-4">
                                <button onClick={() => setSidebarOpen(!isSidebarOpen)} className="md:hidden p-1 text-gray-600"><Menu size={24}/></button>
                                <h2 className="text-lg font-semibold text-gray-700">{activeRole === 'admin' ? 'Admin Panel' : 'User Menu'}</h2>
                            </div>
                            <div className="flex bg-gray-100 rounded-lg p-1">
                                <button onClick={() => { setActiveRole('admin'); setActiveView('dashboard'); }} className={`px-3 py-1 text-sm font-medium rounded-md transition-all ${activeRole === 'admin' ? 'bg-white shadow text-blue-600' : 'text-gray-500'}`}>Admin</button>
                                <button onClick={() => { setActiveRole('user'); setActiveView('user-form'); }} className={`px-3 py-1 text-sm font-medium rounded-md transition-all ${activeRole === 'user' ? 'bg-white shadow text-blue-600' : 'text-gray-500'}`}>User</button>
                            </div>
                        </header>
                        
                        <div className="flex-1 overflow-auto p-4 md:p-6 bg-gray-50">
                            {/* --- ADMIN DASHBOARD --- */}
                            {activeRole === 'admin' && activeView === 'dashboard' && (
                               <div className="space-y-6">
                                   <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                        <StatCard title="Total Item" value={items.length} icon={<Package className="text-blue-600" />} color="bg-blue-50" />
                                        <StatCard title="Stok Menipis" value={items.filter(i => i.stock <= (i.minStock || 5)).length} icon={<AlertTriangle className="text-orange-600" />} color="bg-orange-50" isWarning={true} />
                                        <StatCard title="Transaksi" value={transactions.length} icon={<History className="text-purple-600" />} color="bg-purple-50" />
                                        <StatCard title="Pending" value={requests.filter(r => r.status === 'Pending').length} icon={<ShoppingCart className="text-indigo-600" />} color="bg-indigo-50" />
                                   </div>
                               </div>
                            )}
                            
                            {/* --- ADMIN INVENTORY --- */}
                            {activeRole === 'admin' && activeView === 'inventory' && (
                                <div className="bg-white rounded-xl shadow-sm border p-4">
                                     <div className="flex justify-between mb-4">
                                         <h3 className="font-bold text-gray-700">Master Data</h3>
                                         <div className="flex gap-2">
                                             <button onClick={() => exportTableToExcel('inv-table')} className="bg-green-600 text-white px-3 py-1.5 rounded text-sm flex items-center gap-1"><Download size={16}/> Excel</button>
                                             <button onClick={() => { 
                                                 const n = prompt("Nama Barang:"); if(n) handleAddItem({ name: n, code: `BRG-${Date.now()}`, stock: 0, unit: 'Pcs', price: 0, minStock: 5 }) 
                                             }} className="bg-blue-600 text-white px-3 py-1.5 rounded text-sm flex items-center gap-1"><Plus size={16}/> Tambah</button>
                                         </div>
                                     </div>
                                     <div className="overflow-x-auto">
                                         <table id="inv-table" className="w-full text-sm text-left">
                                             <thead className="bg-gray-50 uppercase text-xs">
                                                 <tr><th className="p-3">Kode</th><th className="p-3">Nama</th><th className="p-3">Stok</th><th className="p-3">Harga</th><th className="p-3 text-right">Aksi</th></tr>
                                             </thead>
                                             <tbody>
                                                 {items.map(i => (
                                                     <tr key={i.id} className="border-b hover:bg-gray-50">
                                                         <td className="p-3 font-mono text-blue-600">{i.code || '-'}</td>
                                                         <td className="p-3">{i.name}</td>
                                                         <td className="p-3">{i.stock} {i.unit}</td>
                                                         <td className="p-3">{formatRupiah(i.price)}</td>
                                                         <td className="p-3 text-right">
                                                             <button onClick={() => { if(confirm('Hapus?')) deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'items', i.id)) }} className="text-red-500"><Trash2 size={16} /></button>
                                                         </td>
                                                     </tr>
                                                 ))}
                                             </tbody>
                                         </table>
                                     </div>
                                </div>
                            )}

                            {/* --- ADMIN REPORT --- */}
                            {activeRole === 'admin' && activeView === 'report' && (
                                <div className="bg-white p-6 rounded-xl shadow-sm border">
                                    <div className="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                                        <div>
                                            <h2 className="text-xl font-bold text-gray-800 flex items-center gap-2"><BarChart3 size={24} className="text-blue-600"/> Laporan</h2>
                                            <div className="flex gap-2 mt-2">
                                                <button onClick={() => setReportType('inventory')} className={`px-3 py-1 text-xs font-bold rounded-full ${reportType === 'inventory' ? 'bg-blue-100 text-blue-700' : 'bg-gray-100 text-gray-500'}`}>Stok Barang</button>
                                                <button onClick={() => setReportType('department')} className={`px-3 py-1 text-xs font-bold rounded-full ${reportType === 'department' ? 'bg-blue-100 text-blue-700' : 'bg-gray-100 text-gray-500'}`}>Per Departemen</button>
                                            </div>
                                        </div>
                                        <div className="flex flex-wrap items-center gap-2 bg-gray-50 p-2 rounded-lg">
                                            <select className="border rounded p-1.5 text-sm" value={selectedYear} onChange={(e) => setSelectedYear(e.target.value)}>{[...Array(5)].map((_, i) => { const y = new Date().getFullYear() - i; return <option key={y} value={y}>{y}</option> })}</select>
                                            <select className="border rounded p-1.5 text-sm" value={selectedMonth} onChange={(e) => setSelectedMonth(e.target.value)}><option value="all">Semua Bulan</option>{["Jan","Feb","Mar","Apr","Mei","Jun","Jul","Agt","Sep","Okt","Nov","Des"].map((m, i) => <option key={i} value={i}>{m}</option>)}</select>
                                            <button onClick={() => exportTableToExcel('report-tbl')} className="bg-green-600 text-white p-1.5 rounded flex items-center gap-1 text-xs font-bold"><Download size={16}/> Excel</button>
                                        </div>
                                    </div>
                                    
                                    <div className="overflow-x-auto mb-6">
                                        <table id="report-tbl" className="w-full text-sm text-left">
                                            <thead className="bg-gray-50 uppercase text-xs">
                                                {reportType === 'inventory' ? (
                                                    selectedMonth !== 'all' ? 
                                                    <tr><th className="p-3">Kode</th><th className="p-3">Nama</th><th className="p-3 text-center">Masuk</th><th className="p-3 text-center">Keluar</th><th className="p-3 text-right">Nilai Masuk</th><th className="p-3 text-right">Nilai Keluar</th></tr> :
                                                    <tr><th className="p-3">Nama</th><th className="p-3 text-center">Total In</th><th className="p-3 text-center">Total Out</th><th className="p-3 text-right">Nilai In</th><th className="p-3 text-right">Nilai Out</th></tr>
                                                ) : (
                                                    <tr><th className="p-3">Departemen</th><th className="p-3 text-center">Jumlah Req</th><th className="p-3 text-right">Total Nilai</th></tr>
                                                )}
                                            </thead>
                                            <tbody>
                                                {reportType === 'inventory' ? reportData.map((row, i) => (
                                                    <tr key={i} className="border-b">
                                                        {selectedMonth !== 'all' ? <>
                                                            <td className="p-3 font-mono text-xs">{row.code}</td><td className="p-3">{row.name}</td>
                                                            <td className="p-3 text-center text-green-600">{row.in}</td><td className="p-3 text-center text-red-600">{row.out}</td>
                                                            <td className="p-3 text-right text-green-600">{formatRupiah(row.inVal)}</td><td className="p-3 text-right text-red-600">{formatRupiah(row.val)}</td>
                                                        </> : <>
                                                            <td className="p-3">{row.name}</td>
                                                            <td className="p-3 text-center">{row.totalIn}</td><td className="p-3 text-center">{row.totalOut}</td>
                                                            <td className="p-3 text-right text-green-600">{formatRupiah(row.totalInVal)}</td><td className="p-3 text-right text-red-600">{formatRupiah(row.val)}</td>
                                                        </>}
                                                    </tr>
                                                )) : deptReportData.map((row, i) => (
                                                    <tr key={i} className="border-b">
                                                        <td className="p-3">{row.name}</td>
                                                        <td className="p-3 text-center">{selectedMonth !== 'all' ? row.count : row.reqCount}</td>
                                                        <td className="p-3 text-right text-blue-600">{formatRupiah(selectedMonth !== 'all' ? row.val : row.totalVal)}</td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                            <tfoot className="bg-gray-100 font-bold">
                                                {reportType === 'inventory' ? (
                                                    <tr>
                                                        <td colSpan={selectedMonth !== 'all' ? 2 : 1} className="p-3 text-right">TOTAL:</td>
                                                        <td className="p-3 text-center text-green-700">{totalQtyIn}</td>
                                                        <td className="p-3 text-center text-red-700">{totalQtyOut}</td>
                                                        <td className="p-3 text-right text-green-700">{formatRupiah(totalValueIn)}</td>
                                                        <td className="p-3 text-right text-red-700">{formatRupiah(totalValueOut)}</td>
                                                    </tr>
                                                ) : (
                                                    <tr><td colSpan="2" className="p-3 text-right">TOTAL:</td><td className="p-3 text-right">{formatRupiah(totalDeptValue)}</td></tr>
                                                )}
                                            </tfoot>
                                        </table>
                                    </div>
                                </div>
                            )}

                            {/* --- USER FORM --- */}
                            {activeRole === 'user' && (activeView === 'user-form' || activeView === 'user-withdrawal') && (
                                <div className="max-w-4xl mx-auto space-y-6">
                                    <div className="bg-white p-4 rounded-xl shadow-sm border">
                                        <h3 className="font-bold text-gray-800 border-b pb-3 mb-4">{activeView === 'user-withdrawal' ? 'Form Pengambilan' : 'Form Permintaan'}</h3>
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                            <div><label className="text-xs font-bold text-gray-500">Nama</label><input className="w-full border p-2 rounded" value={formName} onChange={e => setFormName(e.target.value)} /></div>
                                            <div>
                                                <div className="flex justify-between"><label className="text-xs font-bold text-gray-500">Departemen</label><button onClick={() => {setIsManualDept(!isManualDept); setFormDept('')}} className="text-xs text-blue-500">{isManualDept ? 'List' : 'Manual'}</button></div>
                                                {isManualDept ? <input className="w-full border p-2 rounded bg-yellow-50" value={formDept} onChange={e => setFormDept(e.target.value)} /> : 
                                                <select className="w-full border p-2 rounded" value={formDept} onChange={e => setFormDept(e.target.value)}><option value="">- Pilih -</option>{["HRD", "Finance", "IT", "Operasional", "Marketing", "Gudang"].map(d => <option key={d} value={d}>{d}</option>)}</select>}
                                            </div>
                                        </div>
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                            <div><label className="text-xs font-bold text-gray-500">Tanggal</label><input type="date" className="w-full border p-2 rounded" value={formDate} onChange={e => setFormDate(e.target.value)} /></div>
                                            {activeView !== 'user-withdrawal' && <div><label className="text-xs font-bold text-gray-500">Periode</label><select className="w-full border p-2 rounded" value={formPeriod} onChange={e => setFormPeriod(e.target.value)}><option value="">- Pilih -</option>{["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"].map(m => <option key={m} value={`${m} ${new Date().getFullYear()}`}>{m} {new Date().getFullYear()}</option>)}</select></div>}
                                        </div>
                                        
                                        <div className="bg-gray-50 p-4 rounded-lg mb-4">
                                            <div className="flex gap-2 mb-2 overflow-x-auto pb-2">
                                                <button onClick={() => setInputMode('master')} className={`px-3 py-1 text-xs rounded-full whitespace-nowrap ${inputMode==='master' ? 'bg-blue-600 text-white' : 'bg-gray-200'}`}>Manual Cari</button>
                                                {activeView === 'user-withdrawal' && <button onClick={() => {setInputMode('scan'); setTimeout(() => scanInputRef.current?.focus(), 100)}} className={`px-3 py-1 text-xs rounded-full whitespace-nowrap ${inputMode==='scan' ? 'bg-orange-600 text-white' : 'bg-gray-200'}`}>Scan Barcode</button>}
                                                <button onClick={() => setInputMode('manual')} className={`px-3 py-1 text-xs rounded-full whitespace-nowrap ${inputMode==='manual' ? 'bg-green-600 text-white' : 'bg-gray-200'}`}>Input Baru</button>
                                            </div>
                                            {inputMode === 'master' && <select className="w-full border p-2 rounded mb-2" value={selectedItemId} onChange={e => setSelectedItemId(e.target.value)}><option value="">Pilih Barang...</option>{items.map(i => <option key={i.id} value={i.id}>[{i.code||'-'}] {i.name} (Stok: {i.stock})</option>)}</select>}
                                            {inputMode === 'scan' && <div className="relative mb-2"><input ref={scanInputRef} className="w-full border-2 border-orange-300 p-2 pl-8 rounded" placeholder="Scan..." value={scanCode} onChange={e => setScanCode(e.target.value)} onKeyDown={handleScan} /><ScanBarcode className="absolute left-2 top-2.5 text-orange-400" size={16} /></div>}
                                            {inputMode === 'manual' && <input className="w-full border p-2 rounded mb-2" placeholder="Nama Barang" value={manualName} onChange={e => setManualName(e.target.value)} />}
                                            <div className="flex gap-2">
                                                <input type="number" min="1" className="w-20 border p-2 rounded text-center" value={formQty} onChange={e => setFormQty(e.target.value)} />
                                                <button onClick={handleAddToCart} className="flex-1 bg-blue-600 text-white rounded font-bold text-sm">Tambah</button>
                                            </div>
                                        </div>

                                        {requestList.length > 0 && <div className="border rounded overflow-hidden mb-4"><table className="w-full text-sm text-left"><thead className="bg-gray-100"><tr><th className="p-2">Barang</th><th className="p-2 text-center">Qty</th><th className="p-2 text-right">Aksi</th></tr></thead><tbody>{requestList.map((it, idx) => <tr key={idx} className="border-b"><td className="p-2">{it.name}</td><td className="p-2 text-center">{it.qty}</td><td className="p-2 text-right"><button onClick={() => {const l=[...requestList];l.splice(idx,1);setRequestList(l)}} className="text-red-500"><Trash2 size={16}/></button></td></tr>)}</tbody></table></div>}
                                        
                                        <div className="mb-4">
                                            <h4 className="font-bold text-xs text-gray-500 mb-2">Tanda Tangan</h4>
                                            <div className="border-2 border-dashed h-32 rounded relative">
                                                <SignaturePad ref={sigCanvas} />
                                                <button onClick={() => sigCanvas.current?.clear()} className="absolute top-1 right-1 bg-white shadow p-1 rounded"><Eraser size={14}/></button>
                                            </div>
                                        </div>
                                        <button onClick={() => handleUserSubmit(activeView === 'user-withdrawal' ? 'withdrawal' : 'request')} className="w-full bg-blue-600 text-white py-3 rounded-lg font-bold shadow-lg">Simpan & Cetak</button>
                                    </div>
                                </div>
                            )}

                             {activeRole === 'user' && activeView === 'user-transactions' && (
                                <div className="space-y-4">
                                     {requests.filter(r => r.userId === user.uid).length === 0 ? <p className="text-gray-400">Belum ada riwayat.</p> :
                                     requests.filter(r => r.userId === user.uid).map(r => (
                                         <div key={r.id} className="bg-white p-4 rounded shadow flex justify-between items-center">
                                             <div><p className="font-bold">{r.items.length} Barang</p><p className="text-xs text-gray-500">{r.date}  {r.status}</p></div>
                                             <button onClick={() => setPrintData(r)} className="text-blue-600 underline text-sm">Lihat Dokumen</button>
                                         </div>
                                     ))}
                                </div>
                            )}

                            {activeRole === 'admin' && activeView === 'requests' && (
                                <div className="space-y-4">
                                    {requests.filter(r => r.status === 'Pending').length === 0 ? <p className="text-gray-400">Tidak ada permintaan.</p> : 
                                    requests.filter(r => r.status === 'Pending').map(r => (
                                        <div key={r.id} className="bg-white p-4 rounded shadow border-l-4 border-blue-400">
                                            <div className="flex justify-between items-start">
                                                <div>
                                                    <p className="font-bold">{r.userName} <span className="font-normal text-gray-500 ml-1">({r.department})</span></p>
                                                    <ul className="text-sm list-disc pl-4 mt-1">{r.items && r.items.map((i, idx) => <li key={idx}>{i.name} x{i.qty}</li>)}</ul>
                                                </div>
                                                <div className="flex gap-2">
                                                    <button onClick={() => updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'requests', r.id), {status: 'Rejected'})} className="text-red-500 border border-red-200 px-3 py-1 rounded text-sm">Tolak</button>
                                                    <button onClick={async () => {
                                                        for(const item of r.items) {
                                                            if(item.type === 'master') {
                                                                const dbItem = items.find(x => x.id === item.itemId);
                                                                if(dbItem) await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'items', dbItem.id), {stock: dbItem.stock - item.qty});
                                                            }
                                                        }
                                                        await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'requests', r.id), {status: 'Approved'});
                                                        await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'transactions'), {
                                                            date: new Date().toISOString().split('T')[0], createdAt: new Date().toISOString(), type: 'out',
                                                            itemName: r.items[0].name, qty: r.items.reduce((a,b)=>a+parseInt(b.qty),0), requester: r.userName
                                                        });
                                                        showNotification('Disetujui');
                                                    }} className="bg-blue-600 text-white px-3 py-1 rounded text-sm">Setujui</button>
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}

                             {/* --- HISTORY --- */}
                            {activeRole === 'admin' && activeView === 'history' && (
                                <div className="bg-white p-4 rounded shadow">
                                    <h3 className="font-bold mb-4">Riwayat Transaksi</h3>
                                    <div className="overflow-x-auto"><table className="w-full text-sm"><thead><tr className="border-b text-left"><th className="pb-2">Tanggal</th><th className="pb-2">Barang</th><th className="pb-2">Ket</th></tr></thead><tbody>{transactions.length === 0 ? <tr><td colSpan="3" className="py-2 text-gray-400 text-center">Kosong</td></tr> : transactions.map(t => <tr key={t.id} className="border-b"><td className="py-2">{t.date}</td><td className="py-2">{String(t.itemName)} ({t.qty})</td><td className="py-2 text-gray-500">{String(t.requester)}</td></tr>)}</tbody></table></div>
                                </div>
                            )}

                        </div>
                        <footer className="bg-white border-t py-3 px-6 text-center text-xs text-gray-400">
                        &copy; 2026 Direktorat Operation - Dept Operational Support
                    </footer>
                    </main>
                    
                    {notification && <div className={`fixed bottom-5 right-5 px-6 py-3 rounded-lg shadow-lg text-white z-50 ${notification.type === 'error' ? 'bg-red-500' : 'bg-green-600'}`}>{notification.message}</div>}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(React.createElement(App));
    </script>
</body>
</html>
