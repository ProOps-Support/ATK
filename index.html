<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sistem Inventaris ATK</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Babel untuk JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- SheetJS untuk Membaca Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none;  scrollbar-width: none; }
        
        /* Toggle Switch */
        .toggle-checkbox:checked {
            right: 0;
            border-color: #3b82f6;
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #3b82f6;
        }
        
        @media print {
            body * { visibility: hidden; }
            #print-area, #print-area * { visibility: visible; }
            #print-area { position: absolute; left: 0; top: 0; width: 100%; margin: 0; padding: 0; }
            .print\:hidden { display: none !important; }
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">
    <div id="root"></div>

    <!-- Script Utama dengan type="text/babel" -->
    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef, useMemo } from 'https://esm.sh/react@18.2.0';
        import ReactDOM from 'https://esm.sh/react-dom@18.2.0/client';
        import { 
            LayoutDashboard, Package, ShoppingCart, History, Menu, Plus, Search, Trash2, Edit, Check, X, 
            AlertTriangle, ArrowUpRight, ArrowDownLeft, Banknote, FileText, Printer, Camera, Upload, Save, 
            Eraser, Users, Wifi, WifiOff, Calendar, ClipboardList, LogOut, ScanBarcode, QrCode, Tag, 
            BarChart3, TrendingUp, Filter, Building2, Download, Info, Database, Bell, Shield, Server,
            Lock, User, Key, Eye, EyeOff, ShieldCheck, ShieldAlert, Loader2, Rocket, MessageCircle, FileSpreadsheet, Link as LinkIcon, RefreshCw
        } from 'https://esm.sh/lucide-react@0.303.0';

        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { 
            getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy, serverTimestamp, getDoc, setDoc, writeBatch
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { 
            getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // --- CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyAn5SPEUZO8sIoYSL0YvRON80C-OzS7odA",
            authDomain: "stock-atk-2a300.firebaseapp.com",
            projectId: "stock-atk-2a300",
            storageBucket: "stock-atk-2a300.firebasestorage.app",
            messagingSenderId: "800795365519",
            appId: "1:800795365519:web:766e630bd962235ba8e0fa"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const appId = 'stock-atk-prod'; 

        // --- HELPERS ---
        const formatRupiah = (number) => {
            const val = Number(number) || 0;
            return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(val);
        };

        const exportTableToExcel = (tableId, filename = 'download.xls') => {
            const table = document.getElementById(tableId);
            if (!table) return;
            const html = table.outerHTML;
            const blob = new Blob([`
                <html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:x='urn:schemas-microsoft-com:office:excel' xmlns='http://www.w3.org/TR/REC-html40'>
                <head><meta charset='utf-8'></head><body>${html}</body></html>
            `], { type: 'application/vnd.ms-excel' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        };

        // --- COMPONENTS ---

        const NavItem = ({ icon, label, isActive, onClick, isOpen, count }) => (
            <button onClick={onClick} className={`w-full flex items-center px-4 py-3 transition-colors ${isActive ? 'bg-slate-800 border-r-4 border-blue-500 text-blue-400' : 'text-slate-300 hover:bg-slate-800'}`}>
                <span className="mr-3 shrink-0">{icon}</span>
                <span className={`flex-1 text-left text-sm font-medium whitespace-nowrap overflow-hidden transition-all duration-300 ${isOpen ? 'opacity-100 w-auto' : 'opacity-0 w-0'}`}>
                    {label}
                </span>
                {isOpen && count > 0 && <span className="bg-red-500 text-white text-xs px-2 py-0.5 rounded-full ml-auto">{count}</span>}
            </button>
        );

        const StatCard = ({ title, value, icon, color, isWarning }) => (
            <div className={`p-4 rounded-xl shadow-sm border border-gray-100 flex items-center justify-between ${isWarning ? 'ring-2 ring-red-100' : ''} bg-white`}>
                <div><p className="text-xs font-medium text-gray-500">{title}</p><h3 className="text-xl font-bold mt-1">{value}</h3></div>
                <div className={`p-2 rounded-lg ${color}`}>{icon}</div>
            </div>
        );

        // --- LOGIN SCREEN ---
        const LoginScreen = ({ onLogin, storedCredentials }) => {
            const [username, setUsername] = useState('');
            const [password, setPassword] = useState('');
            const [showPassword, setShowPassword] = useState(false);
            const [error, setError] = useState('');

            const handleSubmit = (e) => {
                e.preventDefault();
                const validUser = storedCredentials?.adminUser || 'admin';
                const validPass = storedCredentials?.adminPass || 'admin123';

                if (username === validUser && password === validPass) {
                    onLogin();
                } else {
                    setError('Username atau Password salah!');
                }
            };

            return (
                <div className="min-h-screen flex items-center justify-center bg-gray-100 p-4">
                    <div className="bg-white p-8 rounded-xl shadow-lg max-w-sm w-full border border-gray-200">
                        <div className="text-center mb-6">
                            <div className="bg-blue-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 text-blue-600">
                                <Lock size={32} />
                            </div>
                            <h2 className="text-2xl font-bold text-gray-800">Login Admin</h2>
                            <p className="text-sm text-gray-500">Sistem Inventaris ATK</p>
                        </div>
                        
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">Username</label>
                                <div className="relative">
                                    <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-gray-400">
                                        <User size={18} />
                                    </div>
                                    <input 
                                        type="text" 
                                        className="w-full pl-10 pr-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition-all"
                                        placeholder="Masukkan username"
                                        value={username}
                                        onChange={(e) => setUsername(e.target.value)}
                                    />
                                </div>
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">Password</label>
                                <div className="relative">
                                    <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-gray-400">
                                        <Key size={18} />
                                    </div>
                                    <input 
                                        type={showPassword ? "text" : "password"} 
                                        className="w-full pl-10 pr-10 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition-all"
                                        placeholder="Masukkan password"
                                        value={password}
                                        onChange={(e) => setPassword(e.target.value)}
                                    />
                                    <button 
                                        type="button"
                                        onClick={() => setShowPassword(!showPassword)}
                                        className="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-gray-600"
                                    >
                                        {showPassword ? <EyeOff size={18} /> : <Eye size={18} />}
                                    </button>
                                </div>
                            </div>
                            
                            {error && <p className="text-red-500 text-sm text-center bg-red-50 p-2 rounded">{error}</p>}
                            
                            <button type="submit" className="w-full bg-blue-600 text-white py-2.5 rounded-lg font-bold hover:bg-blue-700 transition-colors shadow-md">
                                Masuk
                            </button>
                        </form>
                    </div>
                </div>
            );
        };

        // --- INFORMATION & SETTINGS VIEW ---
        const InformationView = ({ db, appId, itemsCount, transactionsCount, requestsCount, onUpdateCredentials }) => {
            const [waToken, setWaToken] = useState('');
            const [waGroupId, setWaGroupId] = useState('');
            const [waTarget, setWaTarget] = useState('');
            const [notifPrefs, setNotifPrefs] = useState({
                newRequest: true, stockLow: true, approved: false, rejected: false, itemIn: false, itemOut: false
            });
            const [adminUser, setAdminUser] = useState('');
            const [adminPass, setAdminPass] = useState('');
            const [privacyMode, setPrivacyMode] = useState(true);
            const [showAdminPass, setShowAdminPass] = useState(false);
            const [showWaToken, setShowWaToken] = useState(false);
            
            const [isSaving, setIsSaving] = useState(false);

            const totalDocs = itemsCount + transactionsCount + requestsCount;
            const storageUsedKB = totalDocs * 2; 
            const storagePercent = Math.min((storageUsedKB / 500000) * 100, 100).toFixed(2);

            useEffect(() => {
                const loadSettings = async () => {
                    try {
                        const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'general');
                        const docSnap = await getDoc(docRef);
                        if (docSnap.exists()) {
                            const data = docSnap.data();
                            setWaToken(data.waToken || '');
                            setWaGroupId(data.waGroupId || '');
                            setWaTarget(data.waTarget || '');
                            if (data.notifPrefs) setNotifPrefs(data.notifPrefs);
                            setAdminUser(data.adminUser || 'admin');
                            setAdminPass(data.adminPass || 'admin123');
                            setPrivacyMode(data.privacyMode !== false);
                        } else {
                            setAdminUser('admin');
                            setAdminPass('admin123');
                            setPrivacyMode(true);
                        }
                    } catch (e) { console.error("Load settings error", e); }
                };
                loadSettings();
            }, [db, appId]);

            const handleSave = async () => {
                if (!adminUser || !adminPass) return alert("Username dan Password tidak boleh kosong!");
                setIsSaving(true);
                try {
                    await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'general'), {
                        waToken, waGroupId, waTarget, notifPrefs, 
                        adminUser, adminPass, privacyMode,
                        updatedAt: new Date().toISOString()
                    });
                    
                    if (onUpdateCredentials) {
                        onUpdateCredentials({ adminUser, adminPass, privacyMode });
                    }
                    
                    alert('Pengaturan berhasil disimpan!');
                } catch (e) {
                    alert('Gagal menyimpan pengaturan.');
                    console.error(e);
                } finally {
                    setIsSaving(false);
                }
            };

            const togglePref = (key) => {
                setNotifPrefs(prev => ({ ...prev, [key]: !prev[key] }));
            };

            return (
                <div className="space-y-6">
                    <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                        <h3 className="font-bold text-gray-800 border-b pb-3 mb-4 flex items-center gap-2">
                            <Info size={20} className="text-blue-600"/> Informasi Sistem
                        </h3>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <div>
                                <div className="space-y-3 text-sm">
                                    <div className="flex justify-between"><span className="text-gray-500">Nama Aplikasi</span> <span className="font-medium">Sistem Inventaris ATK</span></div>
                                    <div className="flex justify-between"><span className="text-gray-500">Versi</span> <span className="font-medium">v2.6.0 (Migrasi Data)</span></div>
                                    <div className="flex justify-between"><span className="text-gray-500">Tanggal Pembuatan</span> <span className="font-medium">07 Februari 2026</span></div>
                                    <div className="flex justify-between"><span className="text-gray-500">Departemen</span> <span className="font-medium">Operational Support</span></div>
                                </div>
                            </div>
                            <div>
                                <h4 className="text-sm font-bold text-gray-700 mb-2 flex items-center gap-2"><Database size={16}/> Monitor Penyimpanan (Database)</h4>
                                <div className="w-full bg-gray-200 rounded-full h-4 mb-2">
                                    <div className="bg-green-500 h-4 rounded-full transition-all duration-1000" style={{ width: `${storagePercent}%` }}></div>
                                </div>
                                <div className="flex justify-between text-xs text-gray-500">
                                    <span>Terpakai: {totalDocs} Dokumen (~{storageUsedKB} KB)</span>
                                    <span>{storagePercent}% Penuh</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-200 border-l-4 border-l-blue-500">
                        <h3 className="font-bold text-gray-800 border-b pb-3 mb-4 flex items-center gap-2">
                            <Lock size={20} className="text-blue-600"/> Pengaturan Akun & Privasi
                        </h3>
                        
                        <div className="mb-6 flex items-center justify-between bg-gray-50 p-3 rounded-lg border border-gray-200">
                            <div>
                                <span className="font-bold text-sm block">Mode Privasi (Proteksi Login)</span>
                                <span className="text-xs text-gray-500">{privacyMode ? 'ON: Halaman terkunci (Butuh Login)' : 'OFF: Halaman Publik (Tanpa Login)'}</span>
                            </div>
                            <div className="relative inline-block w-12 mr-2 align-middle select-none transition duration-200 ease-in">
                                <input 
                                    type="checkbox" 
                                    name="toggle" 
                                    id="toggle" 
                                    checked={privacyMode}
                                    onChange={() => setPrivacyMode(!privacyMode)}
                                    className="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"
                                />
                                <label htmlFor="toggle" className={`toggle-label block overflow-hidden h-6 rounded-full cursor-pointer ${privacyMode ? 'bg-blue-600' : 'bg-gray-300'}`}></label>
                            </div>
                        </div>

                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label className="block text-xs font-bold text-gray-500 mb-1">Username Login</label>
                                <div className="relative">
                                    <input type="text" value={adminUser} onChange={e => setAdminUser(e.target.value)} className="w-full border p-2 pl-8 rounded text-sm bg-gray-50" placeholder="Username baru..." />
                                    <User size={16} className="absolute left-2.5 top-2.5 text-gray-400"/>
                                </div>
                            </div>
                            <div>
                                <label className="block text-xs font-bold text-gray-500 mb-1">Password Login</label>
                                <div className="relative">
                                    <input 
                                        type={showAdminPass ? "text" : "password"} 
                                        value={adminPass} 
                                        onChange={e => setAdminPass(e.target.value)} 
                                        className="w-full border p-2 pl-8 pr-8 rounded text-sm bg-gray-50" 
                                        placeholder="Password baru..." 
                                    />
                                    <Key size={16} className="absolute left-2.5 top-2.5 text-gray-400"/>
                                    <button 
                                        onClick={() => setShowAdminPass(!showAdminPass)}
                                        className="absolute right-2 top-2 text-gray-400 hover:text-gray-600"
                                    >
                                        {showAdminPass ? <EyeOff size={16}/> : <Eye size={16}/>}
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                        <h3 className="font-bold text-gray-800 border-b pb-3 mb-4 flex items-center gap-2">
                            <Bell size={20} className="text-green-600"/> Konfigurasi Notifikasi
                        </h3>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <div className="space-y-4">
                                <div>
                                    <label className="block text-xs font-bold text-gray-500 mb-1">API Token WA Gateway</label>
                                    <div className="relative">
                                        <input 
                                            type={showWaToken ? "text" : "password"} 
                                            value={waToken} 
                                            onChange={e => setWaToken(e.target.value)} 
                                            className="w-full border p-2 rounded text-sm pr-8" 
                                            placeholder="Masukkan Token API..." 
                                        />
                                        <button 
                                            onClick={() => setShowWaToken(!showWaToken)}
                                            className="absolute right-2 top-2 text-gray-400 hover:text-gray-600"
                                        >
                                            {showWaToken ? <EyeOff size={16}/> : <Eye size={16}/>}
                                        </button>
                                    </div>
                                </div>
                                <div>
                                    <label className="block text-xs font-bold text-gray-500 mb-1">ID Group WhatsApp</label>
                                    <input type="text" value={waGroupId} onChange={e => setWaGroupId(e.target.value)} className="w-full border p-2 rounded text-sm" placeholder="Contoh: 12036304@g.us" />
                                </div>
                                <div>
                                    <label className="block text-xs font-bold text-gray-500 mb-1">Nomor Tujuan (Admin/PIC)</label>
                                    <input type="text" value={waTarget} onChange={e => setWaTarget(e.target.value)} className="w-full border p-2 rounded text-sm" placeholder="Contoh: 62812345678" />
                                </div>
                            </div>
                            <div>
                                <label className="block text-xs font-bold text-gray-500 mb-3">Pilih Notifikasi Aktif:</label>
                                <div className="space-y-2">
                                    <label className="flex items-center gap-2 text-sm cursor-pointer hover:bg-gray-50 p-2 rounded"><input type="checkbox" checked={notifPrefs.newRequest} onChange={() => togglePref('newRequest')} className="rounded text-blue-600"/> <span>Permintaan Baru</span></label>
                                    <label className="flex items-center gap-2 text-sm cursor-pointer hover:bg-gray-50 p-2 rounded"><input type="checkbox" checked={notifPrefs.stockLow} onChange={() => togglePref('stockLow')} className="rounded text-blue-600"/> <span>Peringatan Stok Menipis</span></label>
                                    <label className="flex items-center gap-2 text-sm cursor-pointer hover:bg-gray-50 p-2 rounded"><input type="checkbox" checked={notifPrefs.approved} onChange={() => togglePref('approved')} className="rounded text-blue-600"/> <span>Status Disetujui</span></label>
                                    <label className="flex items-center gap-2 text-sm cursor-pointer hover:bg-gray-50 p-2 rounded"><input type="checkbox" checked={notifPrefs.rejected} onChange={() => togglePref('rejected')} className="rounded text-blue-600"/> <span>Status Ditolak</span></label>
                                    <label className="flex items-center gap-2 text-sm cursor-pointer hover:bg-gray-50 p-2 rounded"><input type="checkbox" checked={notifPrefs.itemIn} onChange={() => togglePref('itemIn')} className="rounded text-blue-600"/> <span>Barang Masuk (Restock)</span></label>
                                </div>
                            </div>
                        </div>
                        <div className="mt-6 flex justify-end">
                            <button onClick={handleSave} disabled={isSaving} className="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-bold flex items-center gap-2 shadow-sm disabled:opacity-50">
                                <Save size={18}/> {isSaving ? 'Menyimpan...' : 'Simpan Konfigurasi'}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- ADMIN INVENTORY ---
        const Inventory = ({ items, onAdd, onUpdate, onDelete }) => {
            const [isModalOpen, setModalOpen] = useState(false);
            const [isImportOpen, setIsImportOpen] = useState(false);
            const [editingItem, setEditingItem] = useState(null);
            const [formData, setFormData] = useState({ code: '', name: '', stock: 0, unit: 'Pcs', price: 0 });

            // Import State
            const [importMode, setImportMode] = useState('file'); // 'file' or 'url'
            const [sheetUrl, setSheetUrl] = useState('');
            const [importedData, setImportedData] = useState([]);
            const [isProcessingImport, setIsProcessingImport] = useState(false);

            const handleOpenModal = (item = null) => {
                if (item) {
                    setEditingItem(item);
                    setFormData({ code: item.code || '', name: item.name, stock: item.stock, unit: item.unit, price: item.price });
                } else {
                    setEditingItem(null);
                    setFormData({ code: `BRG-${Date.now().toString().slice(-6)}`, name: '', stock: 0, unit: 'Pcs', price: 0 });
                }
                setModalOpen(true);
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                const payload = { name: formData.name, code: formData.code, stock: parseInt(formData.stock), unit: formData.unit, price: parseInt(formData.price), category: 'Umum', minStock: 5 };
                if (editingItem) onUpdate({ ...editingItem, ...payload }); else onAdd(payload);
                setModalOpen(false);
            };

            // IMPORT LOGIC
            const handleFileUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (evt) => {
                    const bstr = evt.target.result;
                    const wb = XLSX.read(bstr, { type: 'binary' });
                    const wsname = wb.SheetNames[0];
                    const ws = wb.Sheets[wsname];
                    const data = XLSX.utils.sheet_to_json(ws);
                    
                    // Mapping data, sesuaikan dengan nama kolom di Excel user
                    const mapped = data.map(row => ({
                        code: row['Kode'] || row['Code'] || `MIG-${Math.floor(Math.random()*10000)}`,
                        name: row['Nama'] || row['Nama Barang'] || row['Name'],
                        stock: parseInt(row['Stok'] || row['Qty'] || row['Stock'] || 0),
                        unit: row['Satuan'] || row['Unit'] || 'Pcs',
                        price: parseInt(row['Harga'] || row['Price'] || 0)
                    })).filter(item => item.name); // Filter baris kosong

                    setImportedData(mapped);
                };
                reader.readAsBinaryString(file);
            };

            const handleUrlFetch = async () => {
                if (!sheetUrl) return alert("Masukkan URL Google Sheet (Format CSV)");
                setIsProcessingImport(true);
                try {
                    const response = await fetch(sheetUrl);
                    const text = await response.text();
                    
                    // Simple CSV Parse
                    const rows = text.split('\n').map(row => row.split(','));
                    const headers = rows[0].map(h => h.trim().toLowerCase());
                    
                    const mapped = rows.slice(1).map(row => {
                        if (row.length < 2) return null; // Skip empty rows
                        const obj = {};
                        headers.forEach((h, i) => obj[h] = row[i]?.replace(/"/g, '').trim());
                        
                        return {
                            code: obj['kode'] || obj['code'] || `URL-${Math.floor(Math.random()*10000)}`,
                            name: obj['nama'] || obj['nama barang'] || obj['name'],
                            stock: parseInt(obj['stok'] || obj['qty'] || obj['stock'] || 0),
                            unit: obj['satuan'] || obj['unit'] || 'Pcs',
                            price: parseInt(obj['harga'] || obj['price'] || 0)
                        };
                    }).filter(item => item && item.name);

                    setImportedData(mapped);
                } catch (e) {
                    alert("Gagal menarik data. Pastikan URL adalah 'Published to Web > CSV' dan akses publik.");
                    console.error(e);
                } finally {
                    setIsProcessingImport(false);
                }
            };

            const processImport = async () => {
                if (importedData.length === 0) return;
                if (!confirm(`Yakin ingin mengimpor ${importedData.length} data?`)) return;
                
                setIsProcessingImport(true);
                // Loop insert (bisa dioptimalkan dengan batch write tapi untuk UX sederhana loop one by one ok)
                let successCount = 0;
                for (const item of importedData) {
                    try {
                        await onAdd(item);
                        successCount++;
                    } catch (e) {
                        console.error("Gagal import item:", item.name);
                    }
                }
                setIsProcessingImport(false);
                setImportedData([]);
                setIsImportOpen(false);
                alert(`Berhasil mengimpor ${successCount} data.`);
            };

            return (
                <div className="bg-white rounded-xl shadow-sm border p-4">
                    <div className="flex justify-between mb-4">
                        <h3 className="font-bold text-gray-700">Master Data Barang</h3>
                        <div className="flex gap-2">
                            <button onClick={() => setIsImportOpen(true)} className="bg-green-700 text-white px-3 py-1.5 rounded text-sm flex items-center gap-1 hover:bg-green-800 transition"><FileSpreadsheet size={16}/> Import Excel/Sheet</button>
                            <button onClick={() => exportTableToExcel('inv-table')} className="bg-green-600 text-white px-3 py-1.5 rounded text-sm flex items-center gap-1 hover:bg-green-700 transition"><Download size={16}/> Excel</button>
                            <button onClick={() => handleOpenModal()} className="bg-blue-600 text-white px-3 py-1.5 rounded text-sm flex items-center gap-1 hover:bg-blue-700 transition"><Plus size={16}/> Tambah</button>
                        </div>
                    </div>
                    <div className="overflow-x-auto">
                        <table id="inv-table" className="w-full text-sm text-left">
                            <thead className="bg-gray-50 uppercase text-xs">
                                <tr>
                                    <th className="p-3">Kode</th><th className="p-3">Nama Barang</th><th className="p-3">Qty (Stok)</th><th className="p-3">Satuan</th><th className="p-3">Harga</th><th className="p-3 text-right">Aksi</th>
                                </tr>
                            </thead>
                            <tbody>
                                {items.length === 0 ? <tr><td colSpan="6" className="p-4 text-center text-gray-400">Data kosong. Tambahkan barang.</td></tr> : items.map(item => (
                                    <tr key={item.id} className="border-b hover:bg-gray-50">
                                        <td className="p-3 font-mono text-blue-600 font-medium">{item.code || '-'}</td>
                                        <td className="p-3 font-medium">{item.name}</td>
                                        <td className="p-3"><span className={`font-bold ${item.stock <= (item.minStock || 5) ? 'text-red-600' : 'text-gray-700'}`}>{item.stock}</span></td>
                                        <td className="p-3 text-gray-500">{item.unit}</td>
                                        <td className="p-3 text-blue-600">{formatRupiah(item.price)}</td>
                                        <td className="p-3 text-right flex justify-end gap-2">
                                            <button onClick={() => handleOpenModal(item)} className="text-blue-500 bg-blue-50 p-1.5 rounded hover:bg-blue-100 transition"><Edit size={16} /></button>
                                            <button onClick={() => onDelete(item.id)} className="text-red-500 bg-red-50 p-1.5 rounded hover:bg-red-100 transition"><Trash2 size={16} /></button>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                    {isModalOpen && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
                            <div className="bg-white p-6 rounded-xl w-full max-w-sm shadow-2xl">
                                <h3 className="font-bold mb-4 flex items-center gap-2">{editingItem ? <Edit size={20} className="text-blue-600"/> : <Plus size={20} className="text-blue-600"/>} {editingItem ? 'Edit Barang' : 'Tambah Barang'}</h3>
                                <form onSubmit={handleSubmit} className="space-y-3">
                                    <div><label className="text-xs font-bold text-gray-500">Kode</label><div className="relative"><input value={formData.code} onChange={e => setFormData({...formData, code: e.target.value})} className="w-full border p-2 pl-8 rounded uppercase font-mono" required/><ScanBarcode className="absolute left-2 top-2 text-gray-400" size={16}/></div></div>
                                    <div><label className="text-xs font-bold text-gray-500">Nama</label><input value={formData.name} onChange={e => setFormData({...formData, name: e.target.value})} className="w-full border p-2 rounded" required /></div>
                                    <div className="grid grid-cols-2 gap-3">
                                        <div><label className="text-xs font-bold text-gray-500">Stok</label><input type="number" value={formData.stock} onChange={e => setFormData({...formData, stock: e.target.value})} className="w-full border p-2 rounded" required /></div>
                                        <div><label className="text-xs font-bold text-gray-500">Satuan</label><input value={formData.unit} onChange={e => setFormData({...formData, unit: e.target.value})} className="w-full border p-2 rounded" required /></div>
                                    </div>
                                    <div><label className="text-xs font-bold text-gray-500">Harga (Rp)</label><input type="number" value={formData.price} onChange={e => setFormData({...formData, price: e.target.value})} className="w-full border p-2 rounded" required /></div>
                                    <div className="pt-2 flex gap-2"><button type="button" onClick={() => setModalOpen(false)} className="flex-1 bg-gray-100 p-2 rounded">Batal</button><button type="submit" className="flex-1 bg-blue-600 text-white p-2 rounded">Simpan</button></div>
                                </form>
                            </div>
                        </div>
                    )}
                    
                    {/* IMPORT MODAL */}
                    {isImportOpen && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
                            <div className="bg-white p-6 rounded-xl w-full max-w-3xl shadow-2xl h-[90vh] flex flex-col">
                                <div className="flex justify-between items-center mb-4 border-b pb-2">
                                    <h3 className="font-bold flex items-center gap-2 text-lg"><FileSpreadsheet size={24} className="text-green-600"/> Import Data (Migrasi)</h3>
                                    <button onClick={() => { setIsImportOpen(false); setImportedData([]); }} className="text-gray-400 hover:text-gray-600"><X size={24}/></button>
                                </div>
                                
                                <div className="flex gap-4 mb-4">
                                    <button onClick={() => setImportMode('file')} className={`flex-1 py-2 rounded-lg font-bold text-sm flex items-center justify-center gap-2 ${importMode==='file'?'bg-green-100 text-green-700 border border-green-300':'bg-gray-50 text-gray-500 border'}`}>
                                        <Upload size={16}/> Upload Excel (.xlsx)
                                    </button>
                                    <button onClick={() => setImportMode('url')} className={`flex-1 py-2 rounded-lg font-bold text-sm flex items-center justify-center gap-2 ${importMode==='url'?'bg-blue-100 text-blue-700 border border-blue-300':'bg-gray-50 text-gray-500 border'}`}>
                                        <LinkIcon size={16}/> Google Sheet (URL)
                                    </button>
                                </div>

                                <div className="bg-gray-50 p-4 rounded-lg border mb-4">
                                    {importMode === 'file' ? (
                                        <div className="text-center">
                                            <input type="file" accept=".xlsx, .xls, .csv" onChange={handleFileUpload} className="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-green-50 file:text-green-700 hover:file:bg-green-100"/>
                                            <p className="text-xs text-gray-400 mt-2">Pastikan kolom header: Kode, Nama, Stok, Satuan, Harga</p>
                                        </div>
                                    ) : (
                                        <div className="space-y-2">
                                            <label className="text-xs font-bold text-gray-500">Google Sheet Published URL (CSV Format)</label>
                                            <div className="flex gap-2">
                                                <input type="text" value={sheetUrl} onChange={e => setSheetUrl(e.target.value)} placeholder="https://docs.google.com/spreadsheets/d/e/.../pub?output=csv" className="flex-1 border p-2 rounded text-sm"/>
                                                <button onClick={handleUrlFetch} disabled={isProcessingImport} className="bg-blue-600 text-white px-4 py-2 rounded text-sm font-bold">{isProcessingImport ? 'Fetching...' : 'Tarik Data'}</button>
                                            </div>
                                            <p className="text-xs text-gray-400">Cara: Di Google Sheet > File > Share > Publish to Web > Pilih 'Comma-separated values (.csv)' > Copy Link</p>
                                        </div>
                                    )}
                                </div>

                                <div className="flex-1 overflow-auto border rounded-lg">
                                    <table className="w-full text-sm text-left">
                                        <thead className="bg-gray-100 sticky top-0">
                                            <tr>
                                                <th className="p-2 border-b">No</th>
                                                <th className="p-2 border-b">Kode</th>
                                                <th className="p-2 border-b">Nama Barang</th>
                                                <th className="p-2 border-b">Stok</th>
                                                <th className="p-2 border-b">Harga</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {importedData.length === 0 ? (
                                                <tr><td colSpan="5" className="p-8 text-center text-gray-400">Belum ada data diimpor. Silakan upload atau tarik data.</td></tr>
                                            ) : importedData.map((d, i) => (
                                                <tr key={i} className="border-b hover:bg-gray-50">
                                                    <td className="p-2 text-gray-500">{i+1}</td>
                                                    <td className="p-2 font-mono text-xs">{d.code}</td>
                                                    <td className="p-2">{d.name}</td>
                                                    <td className="p-2 font-bold">{d.stock} {d.unit}</td>
                                                    <td className="p-2">{formatRupiah(d.price)}</td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                                
                                <div className="mt-4 flex justify-between items-center pt-2 border-t">
                                    <span className="text-sm font-bold text-gray-600">Total: {importedData.length} Data</span>
                                    <div className="flex gap-2">
                                        <button onClick={() => { setIsImportOpen(false); setImportedData([]); }} className="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg">Batal</button>
                                        <button onClick={processImport} disabled={importedData.length === 0 || isProcessingImport} className="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg font-bold shadow disabled:opacity-50 flex items-center gap-2">
                                            {isProcessingImport ? <RefreshCw className="animate-spin" size={16}/> : <Save size={16}/>}
                                            Proses Import
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // --- ADMIN DASHBOARD ---
        const Dashboard = ({ items, requests, transactions }) => {
            const lowStockItems = items.filter(i => i.stock <= i.minStock);
            return (
                <div className="space-y-6">
                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <StatCard title="Total Item" value={items.length} icon={<Package className="text-blue-600" />} color="bg-blue-50" />
                        <StatCard title="Stok Menipis" value={lowStockItems.length} icon={<AlertTriangle className="text-orange-600" />} color="bg-orange-50" isWarning={true} />
                        <StatCard title="Total Transaksi" value={transactions.length} icon={<History className="text-purple-600" />} color="bg-purple-50" />
                        <StatCard title="Permintaan Pending" value={requests.filter(r => r.status === 'Pending').length} icon={<ShoppingCart className="text-indigo-600" />} color="bg-indigo-50" />
                    </div>
                </div>
            );
        };

        // --- REPORT COMPONENT ---
        const ReportView = ({ transactions, items, requests }) => {
            const [reportType, setReportType] = useState('inventory');
            const [selectedYear, setSelectedYear] = useState(new Date().getFullYear());
            const [selectedMonth, setSelectedMonth] = useState('all');
            const months = ["Jan", "Feb", "Mar", "Apr", "Mei", "Jun", "Jul", "Agt", "Sep", "Okt", "Nov", "Des"];
            
            const reportData = useMemo(() => {
                const itemMap = items.reduce((acc, item) => {
                    acc[item.name] = { code: item.code || '-', name: item.name, price: parseInt(item.price) || 0, unit: item.unit, monthlyOut: Array(12).fill(0), monthlyIn: Array(12).fill(0), totalIn: 0, totalOut: 0, totalInVal: 0 };
                    return acc;
                }, {});

                transactions.forEach(t => {
                    const tDate = new Date(t.date);
                    if (tDate.getFullYear() !== parseInt(selectedYear)) return;
                    const key = t.itemName;
                    if (!itemMap[key]) itemMap[key] = { code: 'DEL', name: key, price: 0, unit: '-', monthlyOut: Array(12).fill(0), monthlyIn: Array(12).fill(0), totalIn: 0, totalOut: 0, totalInVal: 0 };
                    const qty = parseInt(t.qty) || 0;
                    if (t.type === 'in') { itemMap[key].monthlyIn[tDate.getMonth()] += qty; itemMap[key].totalIn += qty; itemMap[key].totalInVal += (qty * itemMap[key].price); }
                    else if (t.type === 'out') { itemMap[key].monthlyOut[tDate.getMonth()] += qty; itemMap[key].totalOut += qty; }
                });

                const rows = Object.values(itemMap);
                if (selectedMonth !== 'all') {
                    const m = parseInt(selectedMonth);
                    return rows.map(r => ({ ...r, in: r.monthlyIn[m], out: r.monthlyOut[m], diff: r.monthlyIn[m] - r.monthlyOut[m], val: r.monthlyOut[m] * r.price, inVal: r.monthlyIn[m] * r.price })).filter(r => r.in > 0 || r.out > 0);
                }
                return rows.map(r => ({ ...r, val: r.totalOut * r.price, inVal: r.totalInVal })).filter(r => r.totalIn > 0 || r.totalOut > 0);
            }, [transactions, items, selectedYear, selectedMonth]);

            const deptReportData = useMemo(() => {
                const data = {};
                requests.forEach(req => {
                    if (req.status !== 'Approved') return;
                    const rDate = new Date(req.date);
                    if (rDate.getFullYear() !== parseInt(selectedYear)) return;
                    const m = rDate.getMonth();
                    const dept = req.department || 'Tanpa Dept';
                    if (!data[dept]) data[dept] = { name: dept, monthlyVal: Array(12).fill(0), monthlyCount: Array(12).fill(0), totalVal: 0, reqCount: 0 };
                    let val = 0;
                    req.items?.forEach(i => val += (parseInt(i.qty)||0) * (parseInt(i.price)||0));
                    data[dept].monthlyVal[m] += val; data[dept].monthlyCount[m]++; data[dept].totalVal += val; data[dept].reqCount++;
                });
                const rows = Object.values(data).sort((a,b) => b.totalVal - a.totalVal);
                if (selectedMonth !== 'all') {
                    const m = parseInt(selectedMonth);
                    return rows.map(r => ({ ...r, val: r.monthlyVal[m], count: r.monthlyCount[m] })).filter(r => r.count > 0);
                }
                return rows;
            }, [requests, selectedYear, selectedMonth]);

            const totalValueOut = reportData.reduce((acc, curr) => acc + (curr.val || 0), 0);
            const totalDeptValue = deptReportData.reduce((acc, curr) => acc + (selectedMonth !== 'all' ? curr.val : curr.totalVal), 0);

            return (
                <div className="bg-white p-6 rounded-xl shadow-sm border">
                    <div className="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                        <div>
                            <h2 className="text-xl font-bold text-gray-800 flex items-center gap-2"><BarChart3 size={24} className="text-blue-600"/> Laporan</h2>
                            <div className="flex gap-2 mt-2">
                                <button onClick={() => setReportType('inventory')} className={`px-3 py-1 text-xs font-bold rounded-full ${reportType === 'inventory' ? 'bg-blue-100 text-blue-700' : 'bg-gray-100 text-gray-500'}`}>Stok Barang</button>
                                <button onClick={() => setReportType('department')} className={`px-3 py-1 text-xs font-bold rounded-full ${reportType === 'department' ? 'bg-blue-100 text-blue-700' : 'bg-gray-100 text-gray-500'}`}>Per Departemen</button>
                            </div>
                        </div>
                        <div className="flex flex-wrap items-center gap-2 bg-gray-50 p-2 rounded-lg">
                            <select className="border rounded p-1.5 text-sm" value={selectedYear} onChange={(e) => setSelectedYear(e.target.value)}>{[...Array(5)].map((_, i) => { const y = new Date().getFullYear() - i; return <option key={y} value={y}>{y}</option> })}</select>
                            <select className="border rounded p-1.5 text-sm" value={selectedMonth} onChange={(e) => setSelectedMonth(e.target.value)}><option value="all">Semua Bulan</option>{months.map((m, i) => <option key={i} value={i}>{m}</option>)}</select>
                            <button onClick={() => exportTableToExcel('report-tbl')} className="bg-green-600 text-white p-1.5 rounded flex items-center gap-1 text-xs font-bold"><Download size={16}/> Excel</button>
                        </div>
                    </div>
                    
                    <div className="overflow-x-auto mb-6">
                        <table id="report-tbl" className="w-full text-sm text-left">
                            <thead className="bg-gray-50 uppercase text-xs">
                                {reportType === 'inventory' ? (
                                    selectedMonth !== 'all' ? 
                                    <tr><th className="p-3">Kode</th><th className="p-3">Nama</th><th className="p-3 text-center">Masuk</th><th className="p-3 text-center">Keluar</th><th className="p-3 text-right">Nilai Masuk</th><th className="p-3 text-right">Nilai Keluar</th></tr> :
                                    <tr><th className="p-3">Nama</th><th className="p-3 text-center">Total In</th><th className="p-3 text-center">Total Out</th><th className="p-3 text-right">Nilai In</th><th className="p-3 text-right">Nilai Out</th></tr>
                                ) : (
                                    <tr><th className="p-3">Departemen</th><th className="p-3 text-center">Jumlah Req</th><th className="p-3 text-right">Total Nilai</th></tr>
                                )}
                            </thead>
                            <tbody>
                                {reportType === 'inventory' ? reportData.map((row, i) => (
                                    <tr key={i} className="border-b">
                                        {selectedMonth !== 'all' ? <>
                                            <td className="p-3 font-mono text-xs">{row.code}</td><td className="p-3">{row.name}</td>
                                            <td className="p-3 text-center text-green-600">{row.in}</td><td className="p-3 text-center text-red-600">{row.out}</td>
                                            <td className="p-3 text-right text-green-600">{formatRupiah(row.inVal)}</td><td className="p-3 text-right text-red-600">{formatRupiah(row.val)}</td>
                                        </> : <>
                                            <td className="p-3">{row.name}</td>
                                            <td className="p-3 text-center">{row.totalIn}</td><td className="p-3 text-center">{row.totalOut}</td>
                                            <td className="p-3 text-right text-green-600">{formatRupiah(row.totalInVal)}</td><td className="p-3 text-right text-red-600">{formatRupiah(row.val)}</td>
                                        </>}
                                    </tr>
                                )) : deptReportData.map((row, i) => (
                                    <tr key={i} className="border-b">
                                        <td className="p-3">{row.name}</td>
                                        <td className="p-3 text-center">{selectedMonth !== 'all' ? row.count : row.reqCount}</td>
                                        <td className="p-3 text-right text-blue-600">{formatRupiah(selectedMonth !== 'all' ? row.val : row.totalVal)}</td>
                                    </tr>
                                ))}
                            </tbody>
                            <tfoot className="bg-gray-100 font-bold">
                                {reportType === 'inventory' ? (
                                    <tr><td colSpan={selectedMonth !== 'all' ? 4 : 4} className="p-3 text-right">TOTAL KELUAR:</td><td className="p-3 text-right">{formatRupiah(totalValueOut)}</td></tr>
                                ) : (
                                    <tr><td colSpan="2" className="p-3 text-right">TOTAL:</td><td className="p-3 text-right">{formatRupiah(totalDeptValue)}</td></tr>
                                )}
                            </tfoot>
                        </table>
                    </div>
                </div>
            );
        };

        // --- ADMIN REQUESTS ---
        const Requests = ({ requests, onApprove, onReject }) => (
          <div className="space-y-4">
            {requests.filter(r => r.status === 'Pending').length === 0 ? <p className="text-gray-400">Tidak ada data baru</p> : 
            requests.filter(r => r.status === 'Pending').map(req => (
               <div key={req.id} className="bg-white p-4 rounded shadow border-l-4 border-blue-400">
                  <div className="flex justify-between items-start">
                     <div>
                        <p className="font-bold">{req.userName} <span className="font-normal text-gray-500">({req.department})</span></p>
                        <ul className="text-sm list-disc pl-4 mt-1">{req.items && req.items.map((i,idx) => <li key={idx}>[{i.code}] {i.name} x{i.qty}</li>)}</ul>
                     </div>
                     <div className="flex gap-2">
                        <button onClick={() => onReject(req.id)} className="text-red-500 border border-red-200 px-3 py-1 rounded text-sm">Tolak</button>
                        <button onClick={() => onApprove(req.id)} className="bg-blue-600 text-white px-3 py-1 rounded text-sm">Setujui</button>
                     </div>
                  </div>
               </div>
            ))}
          </div>
        );

        // --- ADMIN HISTORY (UPDATED) ---
        const HistoryView = ({ transactions, items }) => {
            // Helper untuk mendapatkan harga jika tidak tersimpan di transaksi lama
            const getPrice = (t) => {
                if (t.price) return t.price;
                const item = items.find(i => i.name === t.itemName);
                return item ? item.price : 0;
            };

            return (
                <div className="bg-white p-6 rounded-xl shadow-sm border">
                    <div className="flex justify-between items-center mb-6">
                        <h3 className="font-bold text-gray-800 flex items-center gap-2">
                            <History size={20} className="text-purple-600"/> Riwayat Transaksi (In/Out)
                        </h3>
                        <button onClick={() => exportTableToExcel('history-table', 'riwayat_transaksi.xls')} className="bg-green-600 text-white px-3 py-1.5 rounded text-sm flex items-center gap-1">
                            <Download size={16}/> Excel
                        </button>
                    </div>
                    
                    <div className="overflow-x-auto">
                        <table id="history-table" className="w-full text-sm text-left">
                            <thead className="bg-gray-50 uppercase text-xs font-bold text-gray-600 border-b-2 border-gray-100">
                                <tr>
                                    <th className="p-3">Tanggal</th>
                                    <th className="p-3 text-center">Status</th>
                                    <th className="p-3">Nama Barang</th>
                                    <th className="p-3 text-center">Qty</th>
                                    <th className="p-3 text-right">Harga Satuan</th>
                                    <th className="p-3 text-right">Total Nilai</th>
                                    <th className="p-3">Keterangan/User</th>
                                </tr>
                            </thead>
                            <tbody>
                                {transactions.length === 0 ? (
                                    <tr><td colSpan="7" className="py-8 text-gray-400 text-center italic">Belum ada riwayat transaksi</td></tr>
                                ) : (
                                    transactions.map(t => {
                                        const price = getPrice(t);
                                        const total = price * t.qty;
                                        const isIn = t.type === 'in';
                                        
                                        return (
                                            <tr key={t.id} className="border-b hover:bg-gray-50 transition-colors">
                                                <td className="p-3 text-gray-600 whitespace-nowrap">{t.date}</td>
                                                <td className="p-3 text-center">
                                                    <span className={`px-2 py-1 rounded-full text-xs font-bold border ${isIn ? 'bg-green-50 text-green-700 border-green-200' : 'bg-red-50 text-red-700 border-red-200'}`}>
                                                        {isIn ? 'MASUK (IN)' : 'KELUAR (OUT)'}
                                                    </span>
                                                </td>
                                                <td className="p-3 font-medium text-gray-800">{String(t.itemName)}</td>
                                                <td className="p-3 text-center font-bold text-gray-700">{t.qty}</td>
                                                <td className="p-3 text-right text-gray-500">{formatRupiah(price)}</td>
                                                <td className="p-3 text-right font-bold text-gray-700">{formatRupiah(total)}</td>
                                                <td className="p-3 text-gray-500 text-xs italic">{String(t.requester)}</td>
                                            </tr>
                                        );
                                    })
                                )}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        // --- MAIN APP COMPONENT ---
        function App() {
            const [user, setUser] = useState(null);
            const [items, setItems] = useState([]);
            const [transactions, setTransactions] = useState([]);
            const [requests, setRequests] = useState([]);
            const [activeRole, setActiveRole] = useState('admin');
            const [activeView, setActiveView] = useState('dashboard');
            const [isSidebarOpen, setSidebarOpen] = useState(false);
            const [notification, setNotification] = useState(null);
            
            // Login & Privacy State
            const [isLoggedIn, setIsLoggedIn] = useState(false);
            const [storedCredentials, setStoredCredentials] = useState(null);
            const [loadingSettings, setLoadingSettings] = useState(true);

            const showNotification = (msg, type = 'success') => {
                setNotification({ message: msg, type });
                setTimeout(() => setNotification(null), 3000);
            };

            // Auth
            useEffect(() => {
                const init = async () => {
                    try { await signInAnonymously(auth); } catch (e) { console.error(e); }
                };
                init();
                return onAuthStateChanged(auth, setUser);
            }, []);
            
            // Load credentials & Privacy Mode
            useEffect(() => {
                 if (!user) return;
                 const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'general');
                 
                 // Use snapshot listener for realtime updates to privacy mode
                 const unsub = onSnapshot(docRef, (snap) => {
                     setLoadingSettings(false);
                     if(snap.exists()) {
                         setStoredCredentials(snap.data());
                     }
                 }, (err) => {
                     console.log('Settings load err', err);
                     setLoadingSettings(false);
                 });
                 
                 return () => unsub();
            }, [user]);

            useEffect(() => {
                if (!user) return;
                const unsubItems = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'items'), s => setItems(s.docs.map(d => ({id:d.id, ...d.data()})).sort((a,b)=>(a.name||'').localeCompare(b.name||''))));
                const unsubReq = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'requests'), s => setRequests(s.docs.map(d => ({id:d.id, ...d.data()})).sort((a,b)=>new Date(b.createdAt||b.date)-new Date(a.createdAt||a.date))));
                const unsubTrans = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'transactions'), s => setTransactions(s.docs.map(d => ({id:d.id, ...d.data()})).sort((a,b)=>new Date(b.createdAt||b.date)-new Date(a.createdAt||a.date))));
                return () => { unsubItems(); unsubReq(); unsubTrans(); };
            }, [user]);

            const handleAddItem = async (item) => {
                try {
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'items'), {...item, createdAt: new Date().toISOString()});
                    if (item.stock > 0) {
                         await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'transactions'), {
                            date: new Date().toISOString().split('T')[0], 
                            createdAt: new Date().toISOString(), 
                            type: 'in', 
                            itemName: item.name, 
                            qty: item.stock, 
                            price: item.price, // Save price for history
                            requester: 'Initial Stock / Migration'
                         });
                    }
                    showNotification('Tersimpan');
                } catch (e) { showNotification('Gagal', 'error'); }
            };

            const handleUpdateItem = async (item) => { try { await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'items', item.id), item); showNotification('Updated'); } catch (e) { showNotification('Gagal', 'error'); } };
            const handleDeleteItem = async (id) => { if(confirm('Hapus?')) try { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'items', id)); showNotification('Terhapus'); } catch (e) { showNotification('Gagal', 'error'); } };
            
            const handleApprove = async (reqId) => {
                const req = requests.find(r => r.id === reqId);
                if(!req) return;
                try {
                    for(const item of req.items) {
                        if(item.type === 'master') {
                            const dbItem = items.find(x => x.id === item.itemId);
                            if(dbItem) await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'items', dbItem.id), {stock: dbItem.stock - item.qty});
                        }
                    }
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'requests', reqId), {status: 'Approved'});
                    
                    // Create Transaction Log for OUT
                    const mainItem = req.items[0];
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'transactions'), {
                        date: new Date().toISOString().split('T')[0], 
                        createdAt: new Date().toISOString(), 
                        type: 'out',
                        itemName: mainItem.name, 
                        qty: req.items.reduce((a,b)=>a+parseInt(b.qty),0),
                        price: mainItem.price || 0, // Save price for history
                        requester: req.userName
                    });
                    showNotification('Disetujui');
                } catch(e) { showNotification('Error', 'error'); }
            };

            const handleReject = async (reqId) => { try { await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'requests', reqId), {status: 'Rejected'}); showNotification('Ditolak'); } catch(e) { showNotification('Error', 'error'); } };

            const isPrivacyOn = storedCredentials?.privacyMode !== false;

            if (loadingSettings) {
                return <div className="h-screen flex items-center justify-center bg-gray-50"><Loader2 className="animate-spin text-blue-600" size={32}/></div>;
            }

            if (isPrivacyOn && !isLoggedIn) {
                return <LoginScreen onLogin={() => setIsLoggedIn(true)} storedCredentials={storedCredentials} />;
            }

            return (
                <div className="flex h-screen bg-gray-50 text-gray-800 font-sans overflow-hidden">
                    <aside 
                        className={`bg-slate-900 text-white transition-all duration-300 ease-in-out flex flex-col shadow-xl z-20 absolute md:relative h-full ${isSidebarOpen ? 'w-64' : 'w-0 md:w-20'}`}
                        onMouseEnter={() => window.innerWidth >= 768 && setSidebarOpen(true)}
                        onMouseLeave={() => window.innerWidth >= 768 && setSidebarOpen(false)}
                    >
                        <div className="p-4 border-b border-slate-700 flex justify-between items-center">
                             {(isSidebarOpen || window.innerWidth >= 768) && <h1 className={`font-bold text-xl tracking-wider text-blue-400 whitespace-nowrap transition-opacity duration-300 ${isSidebarOpen ? 'opacity-100' : 'md:opacity-0'}`}>ATK INV</h1>}
                            <button onClick={() => setSidebarOpen(!isSidebarOpen)} className="p-1 hover:bg-slate-700 rounded md:hidden"><X size={20}/></button>
                        </div>
                        <nav className="flex-1 py-6 space-y-1 overflow-y-auto no-scrollbar">
                            <NavItem icon={<LayoutDashboard size={20}/>} label="Dashboard" isActive={activeView==='dashboard'} onClick={()=>{setActiveView('dashboard');setSidebarOpen(false)}} isOpen={isSidebarOpen}/>
                            <NavItem icon={<Package size={20}/>} label="Stok Barang" isActive={activeView==='inventory'} onClick={()=>{setActiveView('inventory');setSidebarOpen(false)}} isOpen={isSidebarOpen}/>
                            <NavItem icon={<ShoppingCart size={20}/>} label="Permintaan" isActive={activeView==='requests'} onClick={()=>{setActiveView('requests');setSidebarOpen(false)}} isOpen={isSidebarOpen} count={requests.filter(r=>r.status==='Pending').length}/>
                            <NavItem icon={<BarChart3 size={20}/>} label="Laporan" isActive={activeView==='report'} onClick={()=>{setActiveView('report');setSidebarOpen(false)}} isOpen={isSidebarOpen}/>
                            <NavItem icon={<History size={20}/>} label="Riwayat" isActive={activeView==='history'} onClick={()=>{setActiveView('history');setSidebarOpen(false)}} isOpen={isSidebarOpen}/>
                            <NavItem icon={<Info size={20}/>} label="Informasi" isActive={activeView==='info'} onClick={()=>{setActiveView('info');setSidebarOpen(false)}} isOpen={isSidebarOpen}/>
                        </nav>
                        <div className="p-4 border-t border-slate-700">
                            <div className="flex items-center justify-center">
                                <div className={`w-8 h-8 rounded-full flex items-center justify-center font-bold ${activeRole === 'admin' ? 'bg-blue-500' : 'bg-orange-500'}`}>{activeRole === 'admin' ? 'A' : 'U'}</div>
                            </div>
                        </div>
                    </aside>
                    
                    <main className="flex-1 flex flex-col overflow-hidden relative w-full">
                        <header className="h-16 bg-white border-b flex items-center justify-between px-4 md:px-6 shadow-sm z-10 shrink-0">
                            <div className="flex items-center gap-4">
                                <button onClick={() => setSidebarOpen(!isSidebarOpen)} className="md:hidden p-1 text-gray-600"><Menu size={24}/></button>
                                <h2 className="text-lg font-semibold text-gray-700">Admin Panel</h2>
                            </div>
                            <div className="flex items-center gap-3">
                                {!isPrivacyOn && <span className="text-xs bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full font-bold flex items-center gap-1"><ShieldAlert size={12}/> Mode Publik</span>}
                                {isLoggedIn && <button onClick={() => setIsLoggedIn(false)} className="text-gray-500 hover:text-red-600 p-2" title="Keluar"><LogOut size={20}/></button>}
                            </div>
                        </header>
                        
                        <div className="flex-1 overflow-auto p-4 md:p-6 bg-gray-50">
                           {activeView === 'dashboard' && <Dashboard items={items} requests={requests} transactions={transactions}/>}
                           {activeView === 'inventory' && <Inventory items={items} onAdd={handleAddItem} onUpdate={handleUpdateItem} onDelete={handleDeleteItem}/>}
                           {activeView === 'requests' && <Requests requests={requests} onApprove={handleApprove} onReject={handleReject}/>}
                           {activeView === 'report' && <ReportView transactions={transactions} items={items} requests={requests}/>}
                           {activeView === 'history' && <HistoryView transactions={transactions} items={items} />}
                           {activeView === 'info' && (
                               <InformationView 
                                 db={db} appId={appId} 
                                 itemsCount={items.length} 
                                 transactionsCount={transactions.length} 
                                 requestsCount={requests.length} 
                                 onUpdateCredentials={(creds) => setStoredCredentials(prev => ({...prev, ...creds}))}
                               />
                           )}
                        </div>
                        <footer className="bg-white border-t py-3 px-6 text-center text-xs text-gray-400">
                            &copy; 2026 Direktorat Operation - Dept Operational Support
                        </footer>
                    </main>
                    
                    {notification && <div className={`fixed bottom-5 right-5 px-6 py-3 rounded-lg shadow-lg text-white z-50 ${notification.type === 'error' ? 'bg-red-500' : 'bg-green-600'}`}>{notification.message}</div>}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(React.createElement(App));
    </script>
</body>
</html>
